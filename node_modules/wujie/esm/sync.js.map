{"version":3,"file":"sync.js","names":["anchorElementGenerator","getAnchorElementQueryMap","getSyncUrl","appRouteParse","getDegradeIframe","renderIframeReplaceApp","patchEventTimeStamp","renderElementToContainer","initRenderIframeAndContainer","getWujieById","rawDocumentQuerySelector","syncUrlToWindow","iframeWindow","__WUJIE","sync","id","prefix","winUrlElement","window","location","href","queryMap","curUrl","pathname","search","hash","validShortPath","Object","keys","forEach","shortPath","longPath","startsWith","length","encodeURIComponent","replace","newQuery","map","key","join","history","replaceState","syncUrlToIframe","url","execFlag","inject","idUrl","syncUrl","test","appRoutePath","preAppRoutePath","mainHostPath","clearInactiveAppUrl","sandbox","hrefFlag","activeFlag","pushUrlToWindow","pushState","processAppForHrefJump","addEventListener","filter","iframeBody","call","iframe","contentDocument","degrade","document","documentElement","decodeURIComponent","parentElement","degradeAttrs","shadowRoot","host","el","contentWindow","onunload","unmount","appendChild","firstElementChild"],"sources":["../src/sync.ts"],"sourcesContent":["import { anchorElementGenerator, getAnchorElementQueryMap, getSyncUrl, appRouteParse, getDegradeIframe } from \"./utils\";\nimport { renderIframeReplaceApp, patchEventTimeStamp } from \"./iframe\";\nimport { renderElementToContainer, initRenderIframeAndContainer } from \"./shadow\";\nimport { getWujieById, rawDocumentQuerySelector } from \"./common\";\n\n/**\n * 同步子应用路由到主应用路由\n */\nexport function syncUrlToWindow(iframeWindow: Window): void {\n  const { sync, id, prefix } = iframeWindow.__WUJIE;\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  // 非同步且url上没有当前id的查询参数，否则就要同步参数或者清理参数\n  if (!sync && !queryMap[id]) return (winUrlElement = null);\n  const curUrl = iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n  let validShortPath = \"\";\n  // 处理短路径\n  if (prefix) {\n    Object.keys(prefix).forEach((shortPath) => {\n      const longPath = prefix[shortPath];\n      // 找出最长匹配路径\n      if (curUrl.startsWith(longPath) && (!validShortPath || longPath.length > prefix[validShortPath].length)) {\n        validShortPath = shortPath;\n      }\n    });\n  }\n  // 同步\n  if (sync) {\n    queryMap[id] = window.encodeURIComponent(\n      validShortPath ? curUrl.replace(prefix[validShortPath], `{${validShortPath}}`) : curUrl\n    );\n    // 清理\n  } else {\n    delete queryMap[id];\n  }\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  if (winUrlElement.href !== window.location.href) {\n    window.history.replaceState(null, \"\", winUrlElement.href);\n  }\n  winUrlElement = null;\n}\n\n/**\n * 同步主应用路由到子应用\n */\nexport function syncUrlToIframe(iframeWindow: Window): void {\n  // 获取当前路由路径\n  const { pathname, search, hash } = iframeWindow.location;\n  const { id, url, sync, execFlag, prefix, inject } = iframeWindow.__WUJIE;\n\n  // 只在浏览器刷新或者第一次渲染时同步\n  const idUrl = sync && !execFlag ? getSyncUrl(id, prefix) : url;\n  // 排除href跳转情况\n  const syncUrl = (/^http/.test(idUrl) ? null : idUrl) || url;\n  const { appRoutePath } = appRouteParse(syncUrl);\n\n  const preAppRoutePath = pathname + search + hash;\n  if (preAppRoutePath !== appRoutePath) {\n    iframeWindow.history.replaceState(null, \"\", inject.mainHostPath + appRoutePath);\n  }\n}\n\n/**\n * 清理非激活态的子应用同步参数\n * 主应用采用hash模式时，切换子应用后已销毁的子应用同步参数还存在需要手动清理\n */\nexport function clearInactiveAppUrl(): void {\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  Object.keys(queryMap).forEach((id) => {\n    const sandbox = getWujieById(id);\n    if (!sandbox) return;\n    // 子应用执行过并且已经失活才需要清除\n    if (sandbox.execFlag && sandbox.sync && !sandbox.hrefFlag && !sandbox.activeFlag) {\n      delete queryMap[id];\n    }\n  });\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  if (winUrlElement.href !== window.location.href) {\n    window.history.replaceState(null, \"\", winUrlElement.href);\n  }\n  winUrlElement = null;\n}\n\n/**\n * 推送指定url到主应用路由\n */\nexport function pushUrlToWindow(id: string, url: string): void {\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  queryMap[id] = window.encodeURIComponent(url);\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  window.history.pushState(null, \"\", winUrlElement.href);\n  winUrlElement = null;\n}\n\n/**\n * 应用跳转(window.location.href)情况路由处理\n */\nexport function processAppForHrefJump(): void {\n  window.addEventListener(\"popstate\", () => {\n    let winUrlElement = anchorElementGenerator(window.location.href);\n    const queryMap = getAnchorElementQueryMap(winUrlElement);\n    winUrlElement = null;\n    Object.keys(queryMap)\n      .map((id) => getWujieById(id))\n      .filter((sandbox) => sandbox)\n      .forEach((sandbox) => {\n        const url = queryMap[sandbox.id];\n        const iframeBody = rawDocumentQuerySelector.call(sandbox.iframe.contentDocument, \"body\");\n        // 前进href\n        if (/http/.test(url)) {\n          if (sandbox.degrade) {\n            renderElementToContainer(sandbox.document.documentElement, iframeBody);\n            renderIframeReplaceApp(\n              window.decodeURIComponent(url),\n              getDegradeIframe(sandbox.id).parentElement,\n              sandbox.degradeAttrs\n            );\n          } else\n            renderIframeReplaceApp(\n              window.decodeURIComponent(url),\n              sandbox.shadowRoot.host.parentElement,\n              sandbox.degradeAttrs\n            );\n          sandbox.hrefFlag = true;\n          // href后退\n        } else if (sandbox.hrefFlag) {\n          if (sandbox.degrade) {\n            // 走全套流程，但是事件恢复不需要\n            const { iframe } = initRenderIframeAndContainer(sandbox.id, sandbox.el, sandbox.degradeAttrs);\n            patchEventTimeStamp(iframe.contentWindow, sandbox.iframe.contentWindow);\n            iframe.contentWindow.onunload = () => {\n              sandbox.unmount();\n            };\n            iframe.contentDocument.appendChild(iframeBody.firstElementChild);\n            sandbox.document = iframe.contentDocument;\n          } else renderElementToContainer(sandbox.shadowRoot.host, sandbox.el);\n          sandbox.hrefFlag = false;\n        }\n      });\n  });\n}\n"],"mappings":"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"}