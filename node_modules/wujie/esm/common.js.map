{"version":3,"file":"common.js","names":["idToSandboxCacheMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","idToSandboxMap","Map","getWujieById","id","get","wujie","getOptionsById","options","addSandboxCacheWithWujie","sandbox","wujieCache","set","deleteWujieById","addSandboxCacheWithOptions","documentProxyProperties","modifyLocalProperties","modifyProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","documentEvents","ownerProperties","appDocumentAddEventListenerEvents","appDocumentOnEvents","mainDocumentAddEventListenerEvents","mainAndAppAddEventListenerEvents","appWindowAddEventListenerEvents","appWindowOnEvent","relativeElementTagAttrMap","IMG","A","SOURCE","windowProxyProperties","windowRegWhiteList","rawElementAppendChild","HTMLElement","prototype","appendChild","rawElementRemoveChild","removeChild","rawElementContains","contains","rawHeadInsertBefore","HTMLHeadElement","insertBefore","rawBodyInsertBefore","HTMLBodyElement","rawAddEventListener","Node","addEventListener","rawRemoveEventListener","removeEventListener","rawWindowAddEventListener","rawWindowRemoveEventListener","rawAppendChild","rawDocumentQuerySelector","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","Document","querySelector"],"sources":["../src/common.ts"],"sourcesContent":["import Wujie from \"./sandbox\";\nimport { cacheOptions } from \"./index\";\nexport interface SandboxCache {\n  wujie?: Wujie;\n  options?: cacheOptions;\n}\n\nexport type appAddEventListenerOptions = AddEventListenerOptions & { targetWindow?: Window };\n\n// 全部无界实例和配置存储map\nexport const idToSandboxCacheMap = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE.inject.idToSandboxMap\n  : new Map<String, SandboxCache>();\n\nexport function getWujieById(id: String): Wujie | null {\n  return idToSandboxCacheMap.get(id)?.wujie || null;\n}\n\nexport function getOptionsById(id: String): cacheOptions | null {\n  return idToSandboxCacheMap.get(id)?.options || null;\n}\n\nexport function addSandboxCacheWithWujie(id: string, sandbox: Wujie): void {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, wujie: sandbox });\n  else idToSandboxCacheMap.set(id, { wujie: sandbox });\n}\n\nexport function deleteWujieById(id: string) {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache?.options) idToSandboxCacheMap.set(id, { options: wujieCache.options });\n  idToSandboxCacheMap.delete(id);\n}\n\nexport function addSandboxCacheWithOptions(id: string, options: cacheOptions): void {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, options });\n  else idToSandboxCacheMap.set(id, { options });\n}\n\n// 分类document上需要处理的属性，不同类型会进入不同的处理逻辑\nexport const documentProxyProperties = {\n  // 降级场景下需要本地特殊处理的属性\n  modifyLocalProperties: [\"createElement\", \"createTextNode\", \"documentURI\", \"URL\", \"getElementsByTagName\"],\n\n  // 子应用需要手动修正的属性方法\n  modifyProperties: [\n    \"createElement\",\n    \"createTextNode\",\n    \"documentURI\",\n    \"URL\",\n    \"getElementsByTagName\",\n    \"getElementsByClassName\",\n    \"getElementsByName\",\n    \"getElementById\",\n    \"querySelector\",\n    \"querySelectorAll\",\n    \"documentElement\",\n    \"scrollingElement\",\n    \"forms\",\n    \"images\",\n    \"links\",\n  ],\n\n  // 需要从shadowRoot中获取的属性\n  shadowProperties: [\n    \"activeElement\",\n    \"childElementCount\",\n    \"children\",\n    \"firstElementChild\",\n    \"firstChild\",\n    \"fullscreenElement\",\n    \"lastElementChild\",\n    \"pictureInPictureElement\",\n    \"pointerLockElement\",\n    \"styleSheets\",\n  ],\n\n  // 需要从shadowRoot中获取的方法\n  shadowMethods: [\n    \"append\",\n    \"contains\",\n    \"getSelection\",\n    \"elementFromPoint\",\n    \"elementsFromPoint\",\n    \"getAnimations\",\n    \"replaceChildren\",\n  ],\n\n  // 需要从主应用document中获取的属性\n  documentProperties: [\n    \"characterSet\",\n    \"compatMode\",\n    \"contentType\",\n    \"designMode\",\n    \"dir\",\n    \"doctype\",\n    \"embeds\",\n    \"fullscreenEnabled\",\n    \"hidden\",\n    \"implementation\",\n    \"lastModified\",\n    \"pictureInPictureEnabled\",\n    \"plugins\",\n    \"readyState\",\n    \"referrer\",\n    \"visibilityState\",\n    \"fonts\",\n  ],\n\n  // 需要从主应用document中获取的方法\n  documentMethods: [\n    \"execCommand\",\n    \"createRange\",\n    \"exitFullscreen\",\n    \"exitPictureInPicture\",\n    \"getElementsByTagNameNS\",\n    \"hasFocus\",\n    \"prepend\",\n  ],\n\n  // 需要从主应用document中获取的事件\n  documentEvents: [\n    \"onpointerlockchange\",\n    \"onpointerlockerror\",\n    \"onbeforecopy\",\n    \"onbeforecut\",\n    \"onbeforepaste\",\n    \"onfreeze\",\n    \"onresume\",\n    \"onsearch\",\n    \"onfullscreenchange\",\n    \"onfullscreenerror\",\n    \"onsecuritypolicyviolation\",\n    \"onvisibilitychange\",\n  ],\n\n  // 无需修改原型的属性\n  ownerProperties: [\"head\", \"body\"],\n};\n\n// 需要挂载到子应用iframe document上的事件\nexport const appDocumentAddEventListenerEvents = [\"DOMContentLoaded\", \"readystatechange\"];\nexport const appDocumentOnEvents = [\"onreadystatechange\"];\n// 需要挂载到主应用document上的事件\nexport const mainDocumentAddEventListenerEvents = [\n  \"fullscreenchange\",\n  \"fullscreenerror\",\n  \"selectionchange\",\n  \"visibilitychange\",\n  \"wheel\",\n  \"keydown\",\n  \"keypress\",\n  \"keyup\",\n];\n\n// 需要同时挂载到主应用document和shadow上的事件（互斥）\nexport const mainAndAppAddEventListenerEvents = [\"gotpointercapture\", \"lostpointercapture\"];\n\n// 子应用window监听需要挂载到iframe沙箱上的事件\nexport const appWindowAddEventListenerEvents = [\n  \"hashchange\",\n  \"popstate\",\n  \"DOMContentLoaded\",\n  \"load\",\n  \"beforeunload\",\n  \"unload\",\n  \"message\",\n];\n\n// 子应用window.onXXX需要挂载到iframe沙箱上的事件\nexport const appWindowOnEvent = [\"onload\", \"onbeforeunload\", \"onunload\"];\n\n// 相对路径问题元素的tag和attr的map\nexport const relativeElementTagAttrMap = {\n  IMG: \"src\",\n  A: \"href\",\n  SOURCE: \"src\",\n};\n\n// 需要单独处理的window属性\nexport const windowProxyProperties = [\"getComputedStyle\", \"visualViewport\", \"matchMedia\", \"DOMParser\"];\n\n// window白名单\nexport const windowRegWhiteList = [\n  /animationFrame$/i,\n  /resizeObserver$|mutationObserver$|intersectionObserver$/i,\n  /height$|width$|left$/i,\n  /^screen/i,\n  /X$|Y$/,\n];\n\n// 保存原型方法\n// 子应用的Document.prototype已经被改写了\nexport const rawElementAppendChild = HTMLElement.prototype.appendChild;\nexport const rawElementRemoveChild = HTMLElement.prototype.removeChild;\nexport const rawElementContains = HTMLElement.prototype.contains;\nexport const rawHeadInsertBefore = HTMLHeadElement.prototype.insertBefore;\nexport const rawBodyInsertBefore = HTMLBodyElement.prototype.insertBefore;\nexport const rawAddEventListener = Node.prototype.addEventListener;\nexport const rawRemoveEventListener = Node.prototype.removeEventListener;\nexport const rawWindowAddEventListener = window.addEventListener;\nexport const rawWindowRemoveEventListener = window.removeEventListener;\nexport const rawAppendChild = Node.prototype.appendChild;\nexport const rawDocumentQuerySelector = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\n  : Document.prototype.querySelector;\n"],"mappings":"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"}