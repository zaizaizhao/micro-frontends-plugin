{"version":3,"file":"iframe.js","names":["renderElementToContainer","syncUrlToWindow","fixElementCtrSrcOrHref","isConstructable","anchorElementGenerator","isMatchSyncQueryById","warn","error","execHooks","getCurUrl","getAbsolutePath","setAttrsToElement","setTagToScript","getTagFromScript","documentProxyProperties","rawAddEventListener","rawRemoveEventListener","rawDocumentQuerySelector","mainDocumentAddEventListenerEvents","mainAndAppAddEventListenerEvents","appDocumentAddEventListenerEvents","appDocumentOnEvents","appWindowAddEventListenerEvents","appWindowOnEvent","windowProxyProperties","windowRegWhiteList","rawWindowAddEventListener","rawWindowRemoveEventListener","getJsLoader","WUJIE_TIPS_SCRIPT_ERROR_REQUESTED","WUJIE_DATA_FLAG","patchIframeEvents","iframeWindow","addEventListener","type","listener","options","__WUJIE","plugins","includes","targetWindow","call","window","__WUJIE_RAW_WINDOW__","removeEventListener","patchIframeVariable","wujie","appHostPath","__WUJIE_PUBLIC_PATH__","$wujie","provide","patchIframeHistory","mainHostPath","history","rawHistoryPushState","pushState","rawHistoryReplaceState","replaceState","data","title","url","baseUrl","location","pathname","search","hash","mainUrl","replace","ignoreFlag","undefined","updateBase","URL","href","baseElement","document","setAttribute","patchWindowEffect","processWindowProperty","key","value","bind","e","message","Object","getOwnPropertyNames","forEach","defineProperty","get","some","reg","test","parent","windowOnEvents","filter","p","descriptor","getOwnPropertyDescriptor","enumerable","writable","configurable","set","handler","recordEventListeners","sandbox","Node","prototype","elementListenerList","elementEventCacheMap","find","push","index","findIndex","ele","splice","length","recoverEventListeners","rootElement","WeakMap","ElementIterator","createTreeWalker","NodeFilter","SHOW_ELEMENT","nextElement","currentNode","nextNode","recoverDocumentListeners","oldRootElement","newRootElement","patchEventTimeStamp","Event","createEvent","timeStamp","patchDocumentEffect","handlerCallbackMap","handlerTypeMap","Document","callback","typeList","degrade","shadowRoot","indexOf","elementOnEvents","keys","HTMLElement","documentOnEvent","firstElementChild","val","ownerProperties","modifyProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","documentEvents","concat","propKey","proxyDocument","patchNodeEffect","rawGetRootNode","getRootNode","rawAppendChild","appendChild","rawInsertRule","insertBefore","rootNode","node","res","patchElementEffect","child","patchRelativeUrlEffect","HTMLImageElement","HTMLAnchorElement","HTMLSourceElement","HTMLLinkElement","HTMLScriptElement","HTMLMediaElement","initBase","iframeDocument","createElement","iframeUrlElement","appUrlElement","protocol","host","head","initIframeDom","newDoc","implementation","createHTMLDocument","newDocumentElement","importNode","documentElement","replaceChild","__WUJIE_RAW_DOCUMENT_HEAD__","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","querySelector","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__","querySelectorAll","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","createTextNode","syncIframeUrlToWindow","stopIframeLoading","oldDoc","Promise","resolve","loop","setTimeout","err","stop","execCommand","element","proxyLocation","_hasPatch","defineProperties","baseURI","ownerDocument","insertScriptToIframe","scriptResult","rawElement","src","module","content","crossorigin","crossoriginType","async","attrs","onload","scriptElement","nextScriptElement","jsLoader","code","String","textContent","container","execNextScript","afterExecScript","isOutlineScript","onerror","renderIframeReplaceApp","degradeAttrs","iframe","defaultStyle","style","join","iframeGenerator","appRoutePath","attrsMerge","name","id","body","contentWindow","iframeReady","then"],"sources":["../src/iframe.ts"],"sourcesContent":["import WuJie from \"./sandbox\";\nimport { ScriptObject } from \"./template\";\nimport { renderElementToContainer } from \"./shadow\";\nimport { syncUrlToWindow } from \"./sync\";\nimport {\n  fixElementCtrSrcOrHref,\n  isConstructable,\n  anchorElementGenerator,\n  isMatchSyncQueryById,\n  warn,\n  error,\n  execHooks,\n  getCurUrl,\n  getAbsolutePath,\n  setAttrsToElement,\n  setTagToScript,\n  getTagFromScript,\n} from \"./utils\";\nimport {\n  documentProxyProperties,\n  rawAddEventListener,\n  rawRemoveEventListener,\n  rawDocumentQuerySelector,\n  mainDocumentAddEventListenerEvents,\n  mainAndAppAddEventListenerEvents,\n  appDocumentAddEventListenerEvents,\n  appDocumentOnEvents,\n  appWindowAddEventListenerEvents,\n  appWindowOnEvent,\n  windowProxyProperties,\n  windowRegWhiteList,\n  rawWindowAddEventListener,\n  rawWindowRemoveEventListener,\n} from \"./common\";\nimport type { appAddEventListenerOptions } from \"./common\";\nimport { getJsLoader } from \"./plugin\";\nimport { WUJIE_TIPS_SCRIPT_ERROR_REQUESTED, WUJIE_DATA_FLAG } from \"./constant\";\nimport { ScriptObjectLoader } from \"./index\";\n\ndeclare global {\n  interface Window {\n    // 是否存在无界\n    __POWERED_BY_WUJIE__?: boolean;\n    // 子应用公共加载路径\n    __WUJIE_PUBLIC_PATH__: string;\n    // 原生的querySelector\n    __WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__: typeof Document.prototype.querySelector;\n\n    // iframe内原生的createElement\n    __WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__: typeof Document.prototype.createElement;\n\n    // iframe内原生的createTextNode\n    __WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__: typeof Document.prototype.createTextNode;\n\n    // iframe内原生的head\n    __WUJIE_RAW_DOCUMENT_HEAD__: typeof Document.prototype.head;\n\n    // 原生的querySelector\n    __WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__: typeof Document.prototype.querySelectorAll;\n    // 原生的window对象\n    __WUJIE_RAW_WINDOW__: Window;\n    // 子应用沙盒实例\n    __WUJIE: WuJie;\n    // 子应用mount函数\n    __WUJIE_MOUNT: () => void;\n    // 子应用unmount函数\n    __WUJIE_UNMOUNT: () => void;\n    // document type\n    Document: typeof Document;\n    // img type\n    HTMLImageElement: typeof HTMLImageElement;\n    // node type\n    Node: typeof Node;\n    // element type\n    Element: typeof Element;\n    // htmlElement typeof\n    HTMLElement: typeof HTMLElement;\n    // anchor type\n    HTMLAnchorElement: typeof HTMLAnchorElement;\n    // source type\n    HTMLSourceElement: typeof HTMLSourceElement;\n    // link type\n    HTMLLinkElement: typeof HTMLLinkElement;\n    // script type\n    HTMLScriptElement: typeof HTMLScriptElement;\n    // media type\n    HTMLMediaElement: typeof HTMLMediaElement;\n    EventTarget: typeof EventTarget;\n    Event: typeof Event;\n    ShadowRoot: typeof ShadowRoot;\n    // 注入对象\n    $wujie: { [key: string]: any };\n  }\n  interface HTMLHeadElement {\n    _cacheListeners: Map<string, EventListenerOrEventListenerObject[]>;\n  }\n  interface HTMLBodyElement {\n    _cacheListeners: Map<string, EventListenerOrEventListenerObject[]>;\n  }\n  interface Document {\n    createTreeWalker(\n      root: Node,\n      whatToShow?: number,\n      filter?: NodeFilter | null,\n      entityReferenceExpansion?: boolean\n    ): TreeWalker;\n  }\n}\n\n/**\n * 修改window对象的事件监听，只有路由事件采用iframe的事件\n */\nfunction patchIframeEvents(iframeWindow: Window) {\n  iframeWindow.addEventListener = function addEventListener<K extends keyof WindowEventMap>(\n    type: K,\n    listener: (this: Window, ev: WindowEventMap[K]) => any,\n    options?: boolean | appAddEventListenerOptions\n  ) {\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"windowAddEventListenerHook\", iframeWindow, type, listener, options);\n\n    if (appWindowAddEventListenerEvents.includes(type) || (typeof options === \"object\" && options.targetWindow)) {\n      const targetWindow = typeof options === \"object\" && options.targetWindow ? options?.targetWindow : iframeWindow;\n      return rawWindowAddEventListener.call(targetWindow, type, listener, options);\n    }\n    // 在子应用嵌套场景使用window.window获取真实window\n    rawWindowAddEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);\n  };\n\n  iframeWindow.removeEventListener = function removeEventListener<K extends keyof WindowEventMap>(\n    type: K,\n    listener: (this: Window, ev: WindowEventMap[K]) => any,\n    options?: boolean | appAddEventListenerOptions\n  ) {\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"windowRemoveEventListenerHook\", iframeWindow, type, listener, options);\n\n    if (appWindowAddEventListenerEvents.includes(type) || (typeof options === \"object\" && options.targetWindow)) {\n      const targetWindow = typeof options === \"object\" && options.targetWindow ? options?.targetWindow : iframeWindow;\n      return rawWindowRemoveEventListener.call(targetWindow, type, listener, options);\n    }\n    rawWindowRemoveEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);\n  };\n}\n\nfunction patchIframeVariable(iframeWindow: Window, wujie: WuJie, appHostPath: string): void {\n  iframeWindow.__WUJIE = wujie;\n  iframeWindow.__WUJIE_PUBLIC_PATH__ = appHostPath + \"/\";\n  iframeWindow.$wujie = wujie.provide;\n  iframeWindow.__WUJIE_RAW_WINDOW__ = iframeWindow;\n}\n\n/**\n * 对iframe的history的pushState和replaceState进行修改\n * 将从location劫持后的数据修改回来，防止跨域错误\n * 同步路由到主应用\n * @param iframeWindow\n * @param appHostPath 子应用的 host path\n * @param mainHostPath 主应用的 host path\n */\nfunction patchIframeHistory(iframeWindow: Window, appHostPath: string, mainHostPath: string): void {\n  const history = iframeWindow.history;\n  const rawHistoryPushState = history.pushState;\n  const rawHistoryReplaceState = history.replaceState;\n  history.pushState = function (data: any, title: string, url?: string): void {\n    const baseUrl =\n      mainHostPath + iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n    const mainUrl = getAbsolutePath(url?.replace(appHostPath, \"\"), baseUrl);\n    const ignoreFlag = url === undefined;\n\n    rawHistoryPushState.call(history, data, title, ignoreFlag ? undefined : mainUrl);\n    if (ignoreFlag) return;\n    updateBase(iframeWindow, appHostPath, mainHostPath);\n    syncUrlToWindow(iframeWindow);\n  };\n  history.replaceState = function (data: any, title: string, url?: string): void {\n    const baseUrl =\n      mainHostPath + iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n    const mainUrl = getAbsolutePath(url?.replace(appHostPath, \"\"), baseUrl);\n    const ignoreFlag = url === undefined;\n\n    rawHistoryReplaceState.call(history, data, title, ignoreFlag ? undefined : mainUrl);\n    if (ignoreFlag) return;\n    updateBase(iframeWindow, appHostPath, mainHostPath);\n    syncUrlToWindow(iframeWindow);\n  };\n}\n\n/**\n * 动态的修改iframe的base地址\n * @param iframeWindow\n * @param url\n * @param appHostPath\n * @param mainHostPath\n */\nfunction updateBase(iframeWindow: Window, appHostPath: string, mainHostPath: string) {\n  const baseUrl = new URL(iframeWindow.location.href?.replace(mainHostPath, \"\"), appHostPath);\n  const baseElement = rawDocumentQuerySelector.call(iframeWindow.document, \"base\");\n  if (baseElement) baseElement.setAttribute(\"href\", appHostPath + baseUrl.pathname);\n}\n\n/**\n * patch iframe window effect\n * @param iframeWindow\n */\n// TODO 继续改进\nfunction patchWindowEffect(iframeWindow: Window): void {\n  // 属性处理函数\n  function processWindowProperty(key: string): boolean {\n    const value = iframeWindow[key];\n    try {\n      if (typeof value === \"function\" && !isConstructable(value)) {\n        iframeWindow[key] = window[key].bind(window);\n      } else {\n        iframeWindow[key] = window[key];\n      }\n      return true;\n    } catch (e) {\n      warn(e.message);\n      return false;\n    }\n  }\n  Object.getOwnPropertyNames(iframeWindow).forEach((key) => {\n    // 特殊处理\n    if (key === \"getSelection\") {\n      Object.defineProperty(iframeWindow, key, {\n        get: () => iframeWindow.document[key],\n      });\n      return;\n    }\n    // 单独属性\n    if (windowProxyProperties.includes(key)) {\n      processWindowProperty(key);\n      return;\n    }\n    // 正则匹配，可以一次处理多个\n    windowRegWhiteList.some((reg) => {\n      if (reg.test(key) && key in iframeWindow.parent) {\n        return processWindowProperty(key);\n      }\n      return false;\n    });\n  });\n  // onEvent set\n  const windowOnEvents = Object.getOwnPropertyNames(window)\n    .filter((p) => /^on/.test(p))\n    .filter((e) => !appWindowOnEvent.includes(e));\n\n  // 走主应用window\n  windowOnEvents.forEach((e) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow, e) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow, e, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => window[e],\n        set:\n          descriptor.writable || descriptor.set\n            ? (handler) => {\n                window[e] = typeof handler === \"function\" ? handler.bind(iframeWindow) : handler;\n              }\n            : undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // 运行插件钩子函数\n  execHooks(iframeWindow.__WUJIE.plugins, \"windowPropertyOverride\", iframeWindow);\n}\n\n/**\n * 记录节点的监听事件\n */\nfunction recordEventListeners(iframeWindow: Window) {\n  const sandbox = iframeWindow.__WUJIE;\n  iframeWindow.Node.prototype.addEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    // 添加事件缓存\n    const elementListenerList = sandbox.elementEventCacheMap.get(this);\n    if (elementListenerList) {\n      if (!elementListenerList.find((listener) => listener.handler === handler)) {\n        elementListenerList.push({ type, handler, options });\n      }\n    } else sandbox.elementEventCacheMap.set(this, [{ type, handler, options }]);\n    return rawAddEventListener.call(this, type, handler, options);\n  };\n\n  iframeWindow.Node.prototype.removeEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | EventListenerOptions\n  ): void {\n    // 清除缓存\n    const elementListenerList = sandbox.elementEventCacheMap.get(this);\n    if (elementListenerList) {\n      const index = elementListenerList?.findIndex((ele) => ele.handler === handler);\n      elementListenerList.splice(index, 1);\n    }\n    if (!elementListenerList?.length) {\n      sandbox.elementEventCacheMap.delete(this);\n    }\n    return rawRemoveEventListener.call(this, type, handler, options);\n  };\n}\n\n/**\n * 恢复节点的监听事件\n */\nexport function recoverEventListeners(rootElement: Element | ChildNode, iframeWindow: Window) {\n  const sandbox = iframeWindow.__WUJIE;\n  const elementEventCacheMap: WeakMap<\n    Node,\n    Array<{ type: string; handler: EventListenerOrEventListenerObject; options: any }>\n  > = new WeakMap();\n  const ElementIterator = document.createTreeWalker(rootElement, NodeFilter.SHOW_ELEMENT, null, false);\n  let nextElement = ElementIterator.currentNode;\n  while (nextElement) {\n    const elementListenerList = sandbox.elementEventCacheMap.get(nextElement);\n    if (elementListenerList?.length) {\n      elementEventCacheMap.set(nextElement, elementListenerList);\n      elementListenerList.forEach((listener) => {\n        nextElement.addEventListener(listener.type, listener.handler, listener.options);\n      });\n    }\n    nextElement = ElementIterator.nextNode() as HTMLElement;\n  }\n  sandbox.elementEventCacheMap = elementEventCacheMap;\n}\n\n/**\n * 恢复根节点的监听事件\n */\nexport function recoverDocumentListeners(\n  oldRootElement: Element | ChildNode,\n  newRootElement: Element | ChildNode,\n  iframeWindow: Window\n) {\n  const sandbox = iframeWindow.__WUJIE;\n  const elementEventCacheMap: WeakMap<\n    Node,\n    Array<{ type: string; handler: EventListenerOrEventListenerObject; options: any }>\n  > = new WeakMap();\n  const elementListenerList = sandbox.elementEventCacheMap.get(oldRootElement);\n  if (elementListenerList?.length) {\n    elementEventCacheMap.set(newRootElement, elementListenerList);\n    elementListenerList.forEach((listener) => {\n      newRootElement.addEventListener(listener.type, listener.handler, listener.options);\n    });\n  }\n  sandbox.elementEventCacheMap = elementEventCacheMap;\n}\n\n/**\n * 修复vue绑定事件e.timeStamp < attachedTimestamp 的情况\n */\nexport function patchEventTimeStamp(targetWindow: Window, iframeWindow: Window) {\n  Object.defineProperty(targetWindow.Event.prototype, \"timeStamp\", {\n    get: () => {\n      return iframeWindow.document.createEvent(\"Event\").timeStamp;\n    },\n  });\n}\n\n/**\n * patch document effect\n * @param iframeWindow\n */\n// TODO 继续改进\nfunction patchDocumentEffect(iframeWindow: Window): void {\n  const sandbox = iframeWindow.__WUJIE;\n\n  /**\n   * 处理 addEventListener和removeEventListener\n   * 由于这个劫持导致 handler 的this发生改变，所以需要handler.bind(document)\n   * 但是这样会导致removeEventListener无法正常工作，因为handler => handler.bind(document)\n   * 这个地方保存callback = handler.bind(document) 方便removeEventListener\n   */\n  const handlerCallbackMap: WeakMap<EventListenerOrEventListenerObject, EventListenerOrEventListenerObject> =\n    new WeakMap();\n  const handlerTypeMap: WeakMap<EventListenerOrEventListenerObject, Array<string>> = new WeakMap();\n  iframeWindow.Document.prototype.addEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    let callback = handlerCallbackMap.get(handler);\n    const typeList = handlerTypeMap.get(handler);\n    // 设置 handlerCallbackMap\n    if (!callback && handler) {\n      callback = typeof handler === \"function\" ? handler.bind(this) : handler;\n      handlerCallbackMap.set(handler, callback);\n    }\n    // 设置 handlerTypeMap\n    if (typeList) {\n      if (!typeList.includes(type)) typeList.push(type);\n    } else {\n      handlerTypeMap.set(handler, [type]);\n    }\n\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"documentAddEventListenerHook\", iframeWindow, type, callback, options);\n    if (appDocumentAddEventListenerEvents.includes(type)) {\n      return rawAddEventListener.call(this, type, callback, options);\n    }\n    // 降级统一走 sandbox.document\n    if (sandbox.degrade) return sandbox.document.addEventListener(type, callback, options);\n    if (mainDocumentAddEventListenerEvents.includes(type))\n      return window.document.addEventListener(type, callback, options);\n    if (mainAndAppAddEventListenerEvents.includes(type)) {\n      window.document.addEventListener(type, callback, options);\n      sandbox.shadowRoot.addEventListener(type, callback, options);\n      return;\n    }\n    sandbox.shadowRoot.addEventListener(type, callback, options);\n  };\n  iframeWindow.Document.prototype.removeEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    const callback: EventListenerOrEventListenerObject = handlerCallbackMap.get(handler);\n    const typeList = handlerTypeMap.get(handler);\n    if (callback) {\n      if (typeList?.includes(type)) {\n        typeList.splice(typeList.indexOf(type), 1);\n        if (!typeList.length) {\n          handlerCallbackMap.delete(handler);\n          handlerTypeMap.delete(handler);\n        }\n      }\n\n      // 运行插件钩子函数\n      execHooks(iframeWindow.__WUJIE.plugins, \"documentRemoveEventListenerHook\", iframeWindow, type, callback, options);\n      if (appDocumentAddEventListenerEvents.includes(type)) {\n        return rawRemoveEventListener.call(this, type, callback, options);\n      }\n      if (sandbox.degrade) return sandbox.document.removeEventListener(type, callback, options);\n      if (mainDocumentAddEventListenerEvents.includes(type)) {\n        return window.document.removeEventListener(type, callback, options);\n      }\n      if (mainAndAppAddEventListenerEvents.includes(type)) {\n        window.document.removeEventListener(type, callback, options);\n        sandbox.shadowRoot.removeEventListener(type, callback, options);\n        return;\n      }\n      sandbox.shadowRoot.removeEventListener(type, callback, options);\n    }\n  };\n  // 处理onEvent\n  const elementOnEvents = Object.keys(iframeWindow.HTMLElement.prototype).filter((ele) => /^on/.test(ele));\n  const documentOnEvent = Object.keys(iframeWindow.Document.prototype)\n    .filter((ele) => /^on/.test(ele))\n    .filter((ele) => !appDocumentOnEvents.includes(ele));\n  elementOnEvents\n    .filter((e) => documentOnEvent.includes(e))\n    .forEach((e) => {\n      const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, e) || {\n        enumerable: true,\n        writable: true,\n      };\n      try {\n        Object.defineProperty(iframeWindow.Document.prototype, e, {\n          enumerable: descriptor.enumerable,\n          configurable: true,\n          get: () => (sandbox.degrade ? sandbox.document[e] : sandbox.shadowRoot.firstElementChild[e]),\n          set:\n            descriptor.writable || descriptor.set\n              ? (handler) => {\n                  const val = typeof handler === \"function\" ? handler.bind(iframeWindow.document) : handler;\n                  sandbox.degrade ? (sandbox.document[e] = val) : (sandbox.shadowRoot.firstElementChild[e] = val);\n                }\n              : undefined,\n        });\n      } catch (e) {\n        warn(e.message);\n      }\n    });\n  // 处理属性get\n  const {\n    ownerProperties,\n    modifyProperties,\n    shadowProperties,\n    shadowMethods,\n    documentProperties,\n    documentMethods,\n    documentEvents,\n  } = documentProxyProperties;\n  modifyProperties.concat(shadowProperties, shadowMethods, documentProperties, documentMethods).forEach((propKey) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, propKey) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow.Document.prototype, propKey, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => sandbox.proxyDocument[propKey],\n        set: undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // 处理document专属事件\n  // TODO 内存泄露\n  documentEvents.forEach((propKey) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, propKey) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow.Document.prototype, propKey, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => (sandbox.degrade ? sandbox : window).document[propKey],\n        set:\n          descriptor.writable || descriptor.set\n            ? (handler) => {\n                (sandbox.degrade ? sandbox : window).document[propKey] =\n                  typeof handler === \"function\" ? handler.bind(iframeWindow.document) : handler;\n              }\n            : undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // process owner property\n  ownerProperties.forEach((propKey) => {\n    Object.defineProperty(iframeWindow.document, propKey, {\n      enumerable: true,\n      configurable: true,\n      get: () => sandbox.proxyDocument[propKey],\n      set: undefined,\n    });\n  });\n  // 运行插件钩子函数\n  execHooks(iframeWindow.__WUJIE.plugins, \"documentPropertyOverride\", iframeWindow);\n}\n\n/**\n * patch Node effect\n * 1、处理 getRootNode\n * 2、处理 appendChild、insertBefore，当插入的节点为 svg 时，createElement 的 patch 会被去除，需要重新 patch\n * @param iframeWindow\n */\nfunction patchNodeEffect(iframeWindow: Window): void {\n  const rawGetRootNode = iframeWindow.Node.prototype.getRootNode;\n  const rawAppendChild = iframeWindow.Node.prototype.appendChild;\n  const rawInsertRule = iframeWindow.Node.prototype.insertBefore;\n  iframeWindow.Node.prototype.getRootNode = function (options?: GetRootNodeOptions): Node {\n    const rootNode = rawGetRootNode.call(this, options);\n    if (rootNode === iframeWindow.__WUJIE.shadowRoot) return iframeWindow.document;\n    else return rootNode;\n  };\n  iframeWindow.Node.prototype.appendChild = function <T extends Node>(node: T): T {\n    const res = rawAppendChild.call(this, node);\n    patchElementEffect(node, iframeWindow);\n    return res;\n  };\n  iframeWindow.Node.prototype.insertBefore = function <T extends Node>(node: T, child: Node | null): T {\n    const res = rawInsertRule.call(this, node, child);\n    patchElementEffect(node, iframeWindow);\n    return res;\n  };\n}\n\n/**\n * 修复资源元素的相对路径问题\n * @param iframeWindow\n */\nfunction patchRelativeUrlEffect(iframeWindow: Window): void {\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLImageElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLAnchorElement, \"href\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLSourceElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLLinkElement, \"href\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLScriptElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLMediaElement, \"src\");\n}\n\n/**\n * 初始化base标签\n */\nexport function initBase(iframeWindow: Window, url: string): void {\n  const iframeDocument = iframeWindow.document;\n  const baseElement = iframeDocument.createElement(\"base\");\n  const iframeUrlElement = anchorElementGenerator(iframeWindow.location.href);\n  const appUrlElement = anchorElementGenerator(url);\n  baseElement.setAttribute(\"href\", appUrlElement.protocol + \"//\" + appUrlElement.host + iframeUrlElement.pathname);\n  iframeDocument.head.appendChild(baseElement);\n}\n\n/**\n * 初始化iframe的dom结构\n * @param iframeWindow\n */\nfunction initIframeDom(iframeWindow: Window, wujie: WuJie, mainHostPath: string, appHostPath: string): void {\n  const iframeDocument = iframeWindow.document;\n  const newDoc = window.document.implementation.createHTMLDocument(\"\");\n  const newDocumentElement = iframeDocument.importNode(newDoc.documentElement, true);\n  iframeDocument.documentElement\n    ? iframeDocument.replaceChild(newDocumentElement, iframeDocument.documentElement)\n    : iframeDocument.appendChild(newDocumentElement);\n  iframeWindow.__WUJIE_RAW_DOCUMENT_HEAD__ = iframeDocument.head;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__ = iframeWindow.Document.prototype.querySelector;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__ = iframeWindow.Document.prototype.querySelectorAll;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__ = iframeWindow.Document.prototype.createElement;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__ = iframeWindow.Document.prototype.createTextNode;\n  initBase(iframeWindow, wujie.url);\n  patchIframeHistory(iframeWindow, appHostPath, mainHostPath);\n  patchIframeEvents(iframeWindow);\n  if (wujie.degrade) recordEventListeners(iframeWindow);\n  syncIframeUrlToWindow(iframeWindow);\n\n  patchWindowEffect(iframeWindow);\n  patchDocumentEffect(iframeWindow);\n  patchNodeEffect(iframeWindow);\n  patchRelativeUrlEffect(iframeWindow);\n}\n\n/**\n * 防止运行主应用的js代码，给子应用带来很多副作用\n */\n// TODO 更加准确抓取停止时机\nfunction stopIframeLoading(iframeWindow: Window) {\n  const oldDoc = iframeWindow.document;\n  return new Promise<void>((resolve) => {\n    function loop() {\n      setTimeout(() => {\n        let newDoc = null;\n        try {\n          newDoc = iframeWindow.document;\n        } catch (err) {\n          newDoc = null;\n        }\n        // wait for document ready\n        if (!newDoc || newDoc == oldDoc) {\n          loop();\n        } else {\n          iframeWindow.stop ? iframeWindow.stop() : iframeWindow.document.execCommand(\"Stop\");\n          resolve();\n        }\n      }, 1);\n    }\n    loop();\n  });\n}\n\nexport function patchElementEffect(\n  element: (HTMLElement | Node | ShadowRoot) & { _hasPatch?: boolean },\n  iframeWindow: Window\n): void {\n  const proxyLocation = iframeWindow.__WUJIE.proxyLocation as Location;\n  if (element._hasPatch) return;\n  Object.defineProperties(element, {\n    baseURI: {\n      configurable: true,\n      get: () => proxyLocation.protocol + \"//\" + proxyLocation.host + proxyLocation.pathname,\n      set: undefined,\n    },\n    ownerDocument: {\n      configurable: true,\n      get: () => iframeWindow.document,\n    },\n    _hasPatch: { get: () => true },\n  });\n  execHooks(iframeWindow.__WUJIE.plugins, \"patchElementHook\", element, iframeWindow);\n}\n\n/**\n * 子应用前进后退，同步路由到主应用\n * @param iframeWindow\n */\nexport function syncIframeUrlToWindow(iframeWindow: Window): void {\n  iframeWindow.addEventListener(\"hashchange\", () => syncUrlToWindow(iframeWindow));\n  iframeWindow.addEventListener(\"popstate\", () => {\n    syncUrlToWindow(iframeWindow);\n  });\n}\n\n/**\n * iframe插入脚本\n * @param scriptResult script请求结果\n * @param iframeWindow\n * @param rawElement 原始的脚本\n */\nexport function insertScriptToIframe(\n  scriptResult: ScriptObject | ScriptObjectLoader,\n  iframeWindow: Window,\n  rawElement?: HTMLScriptElement\n) {\n  const { src, module, content, crossorigin, crossoriginType, async, attrs, callback, onload } =\n    scriptResult as ScriptObjectLoader;\n  const scriptElement = iframeWindow.document.createElement(\"script\");\n  const nextScriptElement = iframeWindow.document.createElement(\"script\");\n  const { replace, plugins, proxyLocation } = iframeWindow.__WUJIE;\n  const jsLoader = getJsLoader({ plugins, replace });\n  let code = jsLoader(content, src, getCurUrl(proxyLocation));\n  // 添加属性\n  attrs &&\n    Object.keys(attrs)\n      .filter((key) => !Object.keys(scriptResult).includes(key))\n      .forEach((key) => scriptElement.setAttribute(key, String(attrs[key])));\n\n  // 内联脚本\n  if (content) {\n    // patch location\n    if (!iframeWindow.__WUJIE.degrade && !module) {\n      code = `(function(window, self, global, location) {\n      ${code}\n}).bind(window.__WUJIE.proxy)(\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxyLocation,\n);`;\n    }\n    // 解决 webpack publicPath 为 auto 无法加载资源的问题\n    Object.defineProperty(scriptElement, \"src\", { get: () => src || \"\" });\n  } else {\n    src && scriptElement.setAttribute(\"src\", src);\n    crossorigin && scriptElement.setAttribute(\"crossorigin\", crossoriginType);\n  }\n  module && scriptElement.setAttribute(\"type\", \"module\");\n  scriptElement.textContent = code || \"\";\n  nextScriptElement.textContent =\n    \"if(window.__WUJIE.execQueue && window.__WUJIE.execQueue.length){ window.__WUJIE.execQueue.shift()()}\";\n\n  const container = rawDocumentQuerySelector.call(iframeWindow.document, \"head\");\n  const execNextScript = () => !async && container.appendChild(nextScriptElement);\n  const afterExecScript = () => {\n    onload?.();\n    execNextScript();\n  };\n\n  // 错误情况处理\n  if (/^<!DOCTYPE html/i.test(code)) {\n    error(WUJIE_TIPS_SCRIPT_ERROR_REQUESTED, scriptResult);\n    return execNextScript();\n  }\n\n  // 打标记\n  if (rawElement) {\n    setTagToScript(scriptElement, getTagFromScript(rawElement));\n  }\n  // 外联脚本执行后的处理\n  const isOutlineScript = !content && src;\n  if (isOutlineScript) {\n    scriptElement.onload = afterExecScript;\n    scriptElement.onerror = afterExecScript;\n  }\n  container.appendChild(scriptElement);\n\n  // 调用回调\n  callback?.(iframeWindow);\n  // 执行 hooks\n  execHooks(plugins, \"appendOrInsertElementHook\", scriptElement, iframeWindow, rawElement);\n  // 内联脚本执行后的处理\n  !isOutlineScript && afterExecScript();\n}\n\n/**\n * 加载iframe替换子应用\n * @param src 地址\n * @param shadowRoot\n */\nexport function renderIframeReplaceApp(\n  src: string,\n  element: HTMLElement,\n  degradeAttrs: { [key: string]: any } = {}\n): void {\n  const iframe = window.document.createElement(\"iframe\");\n  const defaultStyle = \"height:100%;width:100%\";\n  setAttrsToElement(iframe, { ...degradeAttrs, src, style: [defaultStyle, degradeAttrs.style].join(\";\") });\n  renderElementToContainer(iframe, element);\n}\n\n/**\n * js沙箱\n * 创建和主应用同源的iframe，路径携带了子路由的路由信息\n * iframe必须禁止加载html，防止进入主应用的路由逻辑\n */\nexport function iframeGenerator(\n  sandbox: WuJie,\n  attrs: { [key: string]: any },\n  mainHostPath: string,\n  appHostPath: string,\n  appRoutePath: string\n): HTMLIFrameElement {\n  const iframe = window.document.createElement(\"iframe\");\n  const attrsMerge = { src: mainHostPath, style: \"display: none\", ...attrs, name: sandbox.id, [WUJIE_DATA_FLAG]: \"\" };\n  setAttrsToElement(iframe, attrsMerge);\n  window.document.body.appendChild(iframe);\n\n  const iframeWindow = iframe.contentWindow;\n  // 变量需要提前注入，在入口函数通过变量防止死循环\n  patchIframeVariable(iframeWindow, sandbox, appHostPath);\n  sandbox.iframeReady = stopIframeLoading(iframeWindow).then(() => {\n    if (!iframeWindow.__WUJIE) {\n      patchIframeVariable(iframeWindow, sandbox, appHostPath);\n    }\n    initIframeDom(iframeWindow, sandbox, mainHostPath, appHostPath);\n    /**\n     * 如果有同步优先同步，非同步从url读取\n     */\n    if (!isMatchSyncQueryById(iframeWindow.__WUJIE.id)) {\n      iframeWindow.history.replaceState(null, \"\", mainHostPath + appRoutePath);\n    }\n  });\n  return iframe;\n}\n"],"mappings":"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"}