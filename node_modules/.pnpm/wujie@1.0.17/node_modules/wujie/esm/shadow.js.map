{"version":3,"file":"shadow.js","names":["WUJIE_APP_ID","WUJIE_IFRAME_CLASS","WUJIE_SHADE_STYLE","CONTAINER_POSITION_DATA_FLAG","CONTAINER_OVERFLOW_DATA_FLAG","LOADING_DATA_FLAG","WUJIE_LOADING_STYLE","WUJIE_LOADING_SVG","getWujieById","rawAppendChild","rawElementAppendChild","rawElementRemoveChild","relativeElementTagAttrMap","getExternalStyleSheets","patchElementEffect","patchRenderEffect","getCssLoader","getPresetLoaders","getAbsolutePath","getContainer","getCurUrl","setAttrsToElement","cssSelectorMap","defineWujieWebComponent","customElements","window","get","WujieApp","shadowRoot","attachShadow","mode","sandbox","getAttribute","iframe","contentWindow","unmount","HTMLElement","define","createWujieWebComponent","id","contentElement","document","createElement","setAttribute","classList","add","renderElementToContainer","element","selectorOrElement","container","contains","querySelector","clearChild","call","initRenderIframeAndContainer","parent","degradeAttrs","createIframeContainer","contentDocument","open","write","close","processCssLoaderForTemplate","html","plugins","replace","proxyLocation","cssLoader","cssBeforeLoaders","cssAfterLoaders","curUrl","Promise","all","fetch","lifecycles","loadError","map","src","contentPromise","then","content","contentList","forEach","styleElement","appendChild","createTextNode","head","body","insertBefore","firstChild","replaceHeadAndBody","headElement","bodyElement","cloneNode","removeChild","parentNode","replaceChild","renderTemplateToHtml","iframeWindow","template","__WUJIE","alive","execFlag","innerHTML","ElementIterator","createTreeWalker","NodeFilter","SHOW_ELEMENT","nextElement","currentNode","relativeAttr","tagName","url","baseURI","nextNode","renderTemplateToShadowRoot","processedHtml","shade","Object","defineProperty","enumerable","configurable","defaultStyle","style","join","renderTemplateToIframe","renderDocument","documentElement","root","addLoading","el","loading","containerStyles","getComputedStyle","position","overflow","setProperty","includes","loadingContainer","removeLoading","positionFlag","overflowFlag","removeProperty","removeAttribute","getPatchStyleElements","rootStyleSheets","rootCssRules","fontCssRules","rootStyleReg","i","length","cssRules","j","cssRuleText","cssText","test","push","match","type","CSSRule","FONT_FACE_RULE","rootStyleSheetElement","fontStyleSheetElement"],"sources":["../src/shadow.ts"],"sourcesContent":["import {\n  WUJIE_APP_ID,\n  WUJIE_IFRAME_CLASS,\n  WUJIE_SHADE_STYLE,\n  CONTAINER_POSITION_DATA_FLAG,\n  CONTAINER_OVERFLOW_DATA_FLAG,\n  LOADING_DATA_FLAG,\n  WUJIE_LOADING_STYLE,\n  WUJIE_LOADING_SVG,\n} from \"./constant\";\nimport {\n  getWujieById,\n  rawAppendChild,\n  rawElementAppendChild,\n  rawElementRemoveChild,\n  relativeElementTagAttrMap,\n} from \"./common\";\nimport { getExternalStyleSheets } from \"./entry\";\nimport Wujie from \"./sandbox\";\nimport { patchElementEffect } from \"./iframe\";\nimport { patchRenderEffect } from \"./effect\";\nimport { getCssLoader, getPresetLoaders } from \"./plugin\";\nimport { getAbsolutePath, getContainer, getCurUrl, setAttrsToElement } from \"./utils\";\n\nconst cssSelectorMap = {\n  \":root\": \":host\",\n};\n\ndeclare global {\n  interface ShadowRoot {\n    head: HTMLHeadElement;\n    body: HTMLBodyElement;\n  }\n}\n\n/**\n * 定义 wujie webComponent，将shadow包裹并获得dom装载和卸载的生命周期\n */\nexport function defineWujieWebComponent() {\n  const customElements = window.customElements;\n  if (customElements && !customElements?.get(\"wujie-app\")) {\n    class WujieApp extends HTMLElement {\n      connectedCallback(): void {\n        if (this.shadowRoot) return;\n        const shadowRoot = this.attachShadow({ mode: \"open\" });\n        const sandbox = getWujieById(this.getAttribute(WUJIE_APP_ID));\n        patchElementEffect(shadowRoot, sandbox.iframe.contentWindow);\n        sandbox.shadowRoot = shadowRoot;\n      }\n\n      disconnectedCallback(): void {\n        const sandbox = getWujieById(this.getAttribute(WUJIE_APP_ID));\n        sandbox?.unmount();\n      }\n    }\n    customElements?.define(\"wujie-app\", WujieApp);\n  }\n}\n\nexport function createWujieWebComponent(id: string): HTMLElement {\n  const contentElement = window.document.createElement(\"wujie-app\");\n  contentElement.setAttribute(WUJIE_APP_ID, id);\n  contentElement.classList.add(WUJIE_IFRAME_CLASS);\n  return contentElement;\n}\n\n/**\n * 将准备好的内容插入容器\n */\nexport function renderElementToContainer(\n  element: Element | ChildNode,\n  selectorOrElement: string | HTMLElement\n): HTMLElement {\n  const container = getContainer(selectorOrElement);\n  if (container && !container.contains(element)) {\n    // 有 loading 无需清理，已经清理过了\n    if (!container.querySelector(`div[${LOADING_DATA_FLAG}]`)) {\n      // 清除内容\n      clearChild(container);\n    }\n    // 插入元素\n    if (element) {\n      rawElementAppendChild.call(container, element);\n    }\n  }\n  return container;\n}\n\n/**\n * 将降级的iframe挂在到容器上并进行初始化\n */\nexport function initRenderIframeAndContainer(\n  id: string,\n  parent: string | HTMLElement,\n  degradeAttrs: { [key: string]: any } = {}\n): { iframe: HTMLIFrameElement; container: HTMLElement } {\n  const iframe = createIframeContainer(id, degradeAttrs);\n  const container = renderElementToContainer(iframe, parent);\n  const contentDocument = iframe.contentWindow.document;\n  contentDocument.open();\n  contentDocument.write(\"<!DOCTYPE html><html><head></head><body></body></html>\");\n  contentDocument.close();\n  return { iframe, container };\n}\n\n/**\n * 处理css-before-loader 以及 css-after-loader\n */\nasync function processCssLoaderForTemplate(sandbox: Wujie, html: HTMLHtmlElement): Promise<HTMLHtmlElement> {\n  const document = sandbox.iframe.contentDocument;\n  const { plugins, replace, proxyLocation } = sandbox;\n  const cssLoader = getCssLoader({ plugins, replace });\n  const cssBeforeLoaders = getPresetLoaders(\"cssBeforeLoaders\", plugins);\n  const cssAfterLoaders = getPresetLoaders(\"cssAfterLoaders\", plugins);\n  const curUrl = getCurUrl(proxyLocation);\n\n  return await Promise.all([\n    Promise.all(\n      getExternalStyleSheets(cssBeforeLoaders, sandbox.fetch, sandbox.lifecycles.loadError).map(\n        ({ src, contentPromise }) => contentPromise.then((content) => ({ src, content }))\n      )\n    ).then((contentList) => {\n      contentList.forEach(({ src, content }) => {\n        if (!content) return;\n        const styleElement = document.createElement(\"style\");\n        styleElement.setAttribute(\"type\", \"text/css\");\n        styleElement.appendChild(document.createTextNode(content ? cssLoader(content, src, curUrl) : content));\n        const head = html.querySelector(\"head\");\n        const body = html.querySelector(\"body\");\n        html.insertBefore(styleElement, head || body || html.firstChild);\n      });\n    }),\n    Promise.all(\n      getExternalStyleSheets(cssAfterLoaders, sandbox.fetch, sandbox.lifecycles.loadError).map(\n        ({ src, contentPromise }) => contentPromise.then((content) => ({ src, content }))\n      )\n    ).then((contentList) => {\n      contentList.forEach(({ src, content }) => {\n        if (!content) return;\n        const styleElement = document.createElement(\"style\");\n        styleElement.setAttribute(\"type\", \"text/css\");\n        styleElement.appendChild(document.createTextNode(content ? cssLoader(content, src, curUrl) : content));\n        html.appendChild(styleElement);\n      });\n    }),\n  ]).then(\n    () => html,\n    () => html\n  );\n}\n\n// 替换html的head和body\nfunction replaceHeadAndBody(html: HTMLHtmlElement, head: HTMLHeadElement, body: HTMLBodyElement): HTMLHtmlElement {\n  const headElement = html.querySelector(\"head\");\n  const bodyElement = html.querySelector(\"body\");\n  if (headElement) {\n    while (headElement.firstChild) {\n      rawAppendChild.call(head, headElement.firstChild.cloneNode(true));\n      headElement.removeChild(headElement.firstChild);\n    }\n    headElement.parentNode.replaceChild(head, headElement);\n  }\n  if (bodyElement) {\n    while (bodyElement.firstChild) {\n      rawAppendChild.call(body, bodyElement.firstChild.cloneNode(true));\n      bodyElement.removeChild(bodyElement.firstChild);\n    }\n    bodyElement.parentNode.replaceChild(body, bodyElement);\n  }\n  return html;\n}\n\n/**\n * 将template渲染成html元素\n */\nfunction renderTemplateToHtml(iframeWindow: Window, template: string): HTMLHtmlElement {\n  const sandbox = iframeWindow.__WUJIE;\n  const { head, body, alive, execFlag } = sandbox;\n  const document = iframeWindow.document;\n  let html = document.createElement(\"html\");\n  html.innerHTML = template;\n  // 组件多次渲染，head和body必须一直使用同一个来应对被缓存的场景\n  if (!alive && execFlag) {\n    html = replaceHeadAndBody(html, head, body);\n  } else {\n    sandbox.head = html.querySelector(\"head\");\n    sandbox.body = html.querySelector(\"body\");\n  }\n  const ElementIterator = document.createTreeWalker(html, NodeFilter.SHOW_ELEMENT, null, false);\n  let nextElement = ElementIterator.currentNode as HTMLElement;\n  while (nextElement) {\n    patchElementEffect(nextElement, iframeWindow);\n    const relativeAttr = relativeElementTagAttrMap[nextElement.tagName];\n    const url = nextElement[relativeAttr];\n    if (relativeAttr) nextElement.setAttribute(relativeAttr, getAbsolutePath(url, nextElement.baseURI || \"\"));\n    nextElement = ElementIterator.nextNode() as HTMLElement;\n  }\n  if (!html.querySelector(\"head\")) {\n    const head = document.createElement(\"head\");\n    html.appendChild(head);\n  }\n  if (!html.querySelector(\"body\")) {\n    const body = document.createElement(\"body\");\n    html.appendChild(body);\n  }\n  return html;\n}\n\n/**\n * 将template渲染到shadowRoot\n */\nexport async function renderTemplateToShadowRoot(\n  shadowRoot: ShadowRoot,\n  iframeWindow: Window,\n  template: string\n): Promise<void> {\n  const html = renderTemplateToHtml(iframeWindow, template);\n  // 处理 css-before-loader 和 css-after-loader\n  const processedHtml = await processCssLoaderForTemplate(iframeWindow.__WUJIE, html);\n  // change ownerDocument\n  shadowRoot.appendChild(processedHtml);\n  const shade = document.createElement(\"div\");\n  shade.setAttribute(\"style\", WUJIE_SHADE_STYLE);\n  processedHtml.insertBefore(shade, processedHtml.firstChild);\n  shadowRoot.head = shadowRoot.querySelector(\"head\");\n  shadowRoot.body = shadowRoot.querySelector(\"body\");\n\n  // 修复 html parentNode\n  Object.defineProperty(shadowRoot.firstChild, \"parentNode\", {\n    enumerable: true,\n    configurable: true,\n    get: () => iframeWindow.document,\n  });\n\n  patchRenderEffect(shadowRoot, iframeWindow.__WUJIE.id, false);\n}\n\nexport function createIframeContainer(id: string, degradeAttrs: { [key: string]: any } = {}): HTMLIFrameElement {\n  const iframe = document.createElement(\"iframe\");\n  const defaultStyle = \"height:100%;width:100%\";\n  setAttrsToElement(iframe, {\n    ...degradeAttrs,\n    style: [defaultStyle, degradeAttrs.style].join(\";\"),\n    [WUJIE_APP_ID]: id,\n  });\n  return iframe;\n}\n\n/**\n * 将template渲染到iframe\n */\nexport async function renderTemplateToIframe(\n  renderDocument: Document,\n  iframeWindow: Window,\n  template: string\n): Promise<void> {\n  // 插入template\n  const html = renderTemplateToHtml(iframeWindow, template);\n  // 处理 css-before-loader 和 css-after-loader\n  const processedHtml = await processCssLoaderForTemplate(iframeWindow.__WUJIE, html);\n  renderDocument.replaceChild(processedHtml, renderDocument.documentElement);\n\n  // 修复 html parentNode\n  Object.defineProperty(renderDocument.documentElement, \"parentNode\", {\n    enumerable: true,\n    configurable: true,\n    get: () => iframeWindow.document,\n  });\n\n  patchRenderEffect(renderDocument, iframeWindow.__WUJIE.id, true);\n}\n\n/**\n * 清除Element所有节点\n */\nexport function clearChild(root: ShadowRoot | Node): void {\n  // 清除内容\n  while (root?.firstChild) {\n    rawElementRemoveChild.call(root, root.firstChild);\n  }\n}\n\n/**\n * 给容器添加loading\n */\nexport function addLoading(el: string | HTMLElement, loading: HTMLElement): void {\n  const container = getContainer(el);\n  clearChild(container);\n  // 给容器设置一些样式，防止 loading 抖动\n  let containerStyles = null;\n  try {\n    containerStyles = window.getComputedStyle(container);\n  } catch {\n    return;\n  }\n  if (containerStyles.position === \"static\") {\n    container.setAttribute(CONTAINER_POSITION_DATA_FLAG, containerStyles.position);\n    container.setAttribute(\n      CONTAINER_OVERFLOW_DATA_FLAG,\n      containerStyles.overflow === \"visible\" ? \"\" : containerStyles.overflow\n    );\n    container.style.setProperty(\"position\", \"relative\");\n    container.style.setProperty(\"overflow\", \"hidden\");\n  } else if ([\"relative\", \"sticky\"].includes(containerStyles.position)) {\n    container.setAttribute(\n      CONTAINER_OVERFLOW_DATA_FLAG,\n      containerStyles.overflow === \"visible\" ? \"\" : containerStyles.overflow\n    );\n    container.style.setProperty(\"overflow\", \"hidden\");\n  }\n  const loadingContainer = document.createElement(\"div\");\n  loadingContainer.setAttribute(LOADING_DATA_FLAG, \"\");\n  loadingContainer.setAttribute(\"style\", WUJIE_LOADING_STYLE);\n  if (loading) loadingContainer.appendChild(loading);\n  else loadingContainer.innerHTML = WUJIE_LOADING_SVG;\n  container.appendChild(loadingContainer);\n}\n/**\n * 移除loading\n */\nexport function removeLoading(el: HTMLElement): void {\n  // 去除容器设置的样式\n  const positionFlag = el.getAttribute(CONTAINER_POSITION_DATA_FLAG);\n  const overflowFlag = el.getAttribute(CONTAINER_OVERFLOW_DATA_FLAG);\n  if (positionFlag) el.style.removeProperty(\"position\");\n  if (overflowFlag !== null) {\n    overflowFlag ? el.style.setProperty(\"overflow\", overflowFlag) : el.style.removeProperty(\"overflow\");\n  }\n  el.removeAttribute(CONTAINER_POSITION_DATA_FLAG);\n  el.removeAttribute(CONTAINER_OVERFLOW_DATA_FLAG);\n  const loadingContainer = el.querySelector(`div[${LOADING_DATA_FLAG}]`);\n  loadingContainer && el.removeChild(loadingContainer);\n}\n/**\n * 获取修复好的样式元素\n * 主要是针对对root样式和font-face样式\n */\nexport function getPatchStyleElements(rootStyleSheets: Array<CSSStyleSheet>): Array<HTMLStyleElement | null> {\n  const rootCssRules = [];\n  const fontCssRules = [];\n  const rootStyleReg = /:root/g;\n\n  // 找出root的cssRules\n  for (let i = 0; i < rootStyleSheets.length; i++) {\n    const cssRules = rootStyleSheets[i]?.cssRules ?? [];\n    for (let j = 0; j < cssRules.length; j++) {\n      const cssRuleText = cssRules[j].cssText;\n      // 如果是root的cssRule\n      if (rootStyleReg.test(cssRuleText)) {\n        rootCssRules.push(cssRuleText.replace(rootStyleReg, (match) => cssSelectorMap[match]));\n      }\n      // 如果是font-face的cssRule\n      if (cssRules[j].type === CSSRule.FONT_FACE_RULE) {\n        fontCssRules.push(cssRuleText);\n      }\n    }\n  }\n\n  let rootStyleSheetElement = null;\n  let fontStyleSheetElement = null;\n\n  // 复制到host上\n  if (rootCssRules.length) {\n    rootStyleSheetElement = window.document.createElement(\"style\");\n    rootStyleSheetElement.innerHTML = rootCssRules.join(\"\");\n  }\n\n  if (fontCssRules.length) {\n    fontStyleSheetElement = window.document.createElement(\"style\");\n    fontStyleSheetElement.innerHTML = fontCssRules.join(\"\");\n  }\n\n  return [rootStyleSheetElement, fontStyleSheetElement];\n}\n"],"mappings":"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"}