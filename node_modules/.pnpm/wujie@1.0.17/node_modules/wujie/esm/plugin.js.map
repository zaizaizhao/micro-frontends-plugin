{"version":3,"file":"plugin.js","names":["compose","getAbsolutePath","getCssLoader","plugins","replace","code","src","base","map","plugin","cssLoader","getJsLoader","jsLoader","getPresetLoaders","loaderType","loaders","filter","length","res","reduce","preLoaders","curLoaders","concat","reverse","getEffectLoaders","isMatchUrl","url","effectLoaders","some","loader","test","cssRelativePathResolve","baseUrl","urlReg","_m","pre","post","absoluteUrl","defaultPlugin","cssBeforeLoaders","content","getPlugins","Array","isArray"],"sources":["../src/plugin.ts"],"sourcesContent":["import { plugin, ScriptObjectLoader } from \"./index\";\nimport { StyleObject } from \"./template\";\nimport { compose, getAbsolutePath } from \"./utils\";\n\ninterface loaderOption {\n  plugins: Array<plugin>;\n  replace: (code: string) => string;\n}\n\n/**\n * 获取柯里化 cssLoader\n */\nexport function getCssLoader({ plugins, replace }: loaderOption) {\n  return (code: string, src: string = \"\", base: string): string =>\n    compose(plugins.map((plugin) => plugin.cssLoader))(replace ? replace(code) : code, src, base);\n}\n\n/**\n * 获取柯里化 jsLoader\n */\nexport function getJsLoader({ plugins, replace }: loaderOption) {\n  return (code: string, src: string = \"\", base: string): string =>\n    compose(plugins.map((plugin) => plugin.jsLoader))(replace ? replace(code) : code, src, base);\n}\n\n/**\n * 获取预置插件\n */\ntype presetLoadersType = \"cssBeforeLoaders\" | \"cssAfterLoaders\" | \"jsBeforeLoaders\" | \"jsAfterLoaders\";\nexport function getPresetLoaders(loaderType: presetLoadersType, plugins: Array<plugin>): plugin[presetLoadersType] {\n  const loaders: (StyleObject | ScriptObjectLoader)[][] = plugins\n    .map((plugin) => plugin[loaderType])\n    .filter((loaders) => loaders?.length);\n  const res = loaders.reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\n  return loaderType === \"cssBeforeLoaders\" ? res.reverse() : res;\n}\n\n/**\n * 获取影响插件\n */\ntype effectLoadersType = \"jsExcludes\" | \"cssExcludes\" | \"jsIgnores\" | \"cssIgnores\";\nexport function getEffectLoaders(loaderType: effectLoadersType, plugins: Array<plugin>): plugin[effectLoadersType] {\n  return plugins\n    .map((plugin) => plugin[loaderType])\n    .filter((loaders) => loaders?.length)\n    .reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\n}\n\n// 判断 url 是否符合loader的规则\nexport function isMatchUrl(url: string, effectLoaders: plugin[effectLoadersType]): boolean {\n  return effectLoaders.some((loader) => (typeof loader === \"string\" ? url === loader : loader.test(url)));\n}\n\n/**\n * 转换子应用css内的相对地址成绝对地址\n */\nfunction cssRelativePathResolve(code: string, src: string, base: string) {\n  const baseUrl = src ? getAbsolutePath(src, base) : base;\n  // https://developer.mozilla.org/en-US/docs/Web/CSS/url\n  const urlReg = /(url\\((?!['\"]?(?:data):)['\"]?)([^'\")]*)(['\"]?\\))/g;\n  return code.replace(urlReg, (_m, pre, url, post) => {\n    const absoluteUrl = getAbsolutePath(url, baseUrl);\n    return pre + absoluteUrl + post;\n  });\n}\n\nconst defaultPlugin = {\n  cssLoader: cssRelativePathResolve,\n  // fix https://github.com/Tencent/wujie/issues/455\n  cssBeforeLoaders: [{ content: \"html {view-transition-name: none;}\" }],\n};\n\nexport function getPlugins(plugins: Array<plugin>): Array<plugin> {\n  return Array.isArray(plugins) ? [defaultPlugin, ...plugins] : [defaultPlugin];\n}\n\nexport default defaultPlugin;\n"],"mappings":"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"}