{"version":3,"file":"effect.js","names":["getExternalStyleSheets","getExternalScripts","getWujieById","rawAppendChild","rawElementContains","rawElementRemoveChild","rawHeadInsertBefore","rawBodyInsertBefore","rawDocumentQuerySelector","rawAddEventListener","rawRemoveEventListener","isFunction","isHijackingTag","requestIdleCallback","warn","nextTick","getCurUrl","execHooks","isScriptElement","setTagToScript","getTagFromScript","setAttrsToElement","insertScriptToIframe","patchElementEffect","getPatchStyleElements","getCssLoader","getEffectLoaders","isMatchUrl","WUJIE_SCRIPT_ID","WUJIE_DATA_FLAG","WUJIE_TIPS_REPEAT_RENDER","WUJIE_TIPS_NO_SCRIPT","parseTagAttributes","patchCustomEvent","e","elementGetter","Object","defineProperties","srcElement","get","target","manualInvokeElementEvent","element","event","customEvent","CustomEvent","patchedEvent","dispatchEvent","handleStylesheetElementPatch","stylesheetElement","sandbox","innerHTML","degrade","patcher","sheet","hostStyleSheetElement","fontStyleSheetElement","shadowRoot","head","appendChild","host","_patcher","undefined","clearTimeout","setTimeout","patchStylesheetElement","cssLoader","curUrl","_hasPatchStyle","innerHTMLDesc","getOwnPropertyDescriptor","Element","prototype","innerTextDesc","HTMLElement","textContentDesc","Node","RawInsertRule","insertRule","patchSheetInsertRule","rule","index","innerText","call","set","code","textContent","value","node","nodeType","TEXT_NODE","res","ownerDocument","createTextNode","dynamicScriptExecStack","Promise","resolve","rewriteAppendOrInsertChild","opts","appendChildOrInsertBefore","newChild","refChild","rawDOMAppendOrInsertBefore","wujieId","styleSheetElements","replace","fetch","plugins","iframe","lifecycles","proxyLocation","fiber","tagName","contentWindow","iframeDocument","contentDocument","toUpperCase","href","rel","type","styleFlag","endsWith","src","ignore","loadError","forEach","contentPromise","then","content","rawAttrs","outerHTML","createElement","attrs","push","comment","createComment","text","crossOrigin","execScript","scriptResult","onload","scriptOptions","module","crossorigin","crossoriginType","execQueue","execQueueLength","length","shift","getAttribute","findScriptElementFromIframe","rawElement","wujieTag","targetScript","__WUJIE_RAW_DOCUMENT_HEAD__","querySelector","rewriteContains","contains","other","rewriteRemoveChild","removeChild","child","patchEventListener","listenerMap","Map","_cacheListeners","addEventListener","listener","options","listeners","removeEventListener","typeListeners","indexOf","splice","entries","patchRenderEffect","render","id","body","insertBefore","bind"],"sources":["../src/effect.ts"],"sourcesContent":["import { getExternalStyleSheets, getExternalScripts } from \"./entry\";\nimport {\n  getWujieById,\n  rawAppendChild,\n  rawElementContains,\n  rawElementRemoveChild,\n  rawHeadInsertBefore,\n  rawBodyInsertBefore,\n  rawDocumentQuerySelector,\n  rawAddEventListener,\n  rawRemoveEventListener,\n} from \"./common\";\nimport {\n  isFunction,\n  isHijackingTag,\n  requestIdleCallback,\n  warn,\n  nextTick,\n  getCurUrl,\n  execHooks,\n  isScriptElement,\n  setTagToScript,\n  getTagFromScript,\n  setAttrsToElement,\n} from \"./utils\";\nimport { insertScriptToIframe, patchElementEffect } from \"./iframe\";\nimport Wujie from \"./sandbox\";\nimport { getPatchStyleElements } from \"./shadow\";\nimport { getCssLoader, getEffectLoaders, isMatchUrl } from \"./plugin\";\nimport { WUJIE_SCRIPT_ID, WUJIE_DATA_FLAG, WUJIE_TIPS_REPEAT_RENDER, WUJIE_TIPS_NO_SCRIPT } from \"./constant\";\nimport { ScriptObject, parseTagAttributes } from \"./template\";\n\nfunction patchCustomEvent(\n  e: CustomEvent,\n  elementGetter: () => HTMLScriptElement | HTMLLinkElement | null\n): CustomEvent {\n  Object.defineProperties(e, {\n    srcElement: {\n      get: elementGetter,\n    },\n    target: {\n      get: elementGetter,\n    },\n  });\n\n  return e;\n}\n\n/**\n * 手动触发事件回调\n */\nfunction manualInvokeElementEvent(element: HTMLLinkElement | HTMLScriptElement, event: string): void {\n  const customEvent = new CustomEvent(event);\n  const patchedEvent = patchCustomEvent(customEvent, () => element);\n  if (isFunction(element[`on${event}`])) {\n    element[`on${event}`](patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\n/**\n * 样式元素的css变量处理，每个stylesheetElement单独节流\n */\nfunction handleStylesheetElementPatch(stylesheetElement: HTMLStyleElement & { _patcher?: any }, sandbox: Wujie) {\n  if (!stylesheetElement.innerHTML || sandbox.degrade) return;\n  const patcher = () => {\n    const [hostStyleSheetElement, fontStyleSheetElement] = getPatchStyleElements([stylesheetElement.sheet]);\n    if (hostStyleSheetElement) {\n      sandbox.shadowRoot.head.appendChild(hostStyleSheetElement);\n    }\n    if (fontStyleSheetElement) {\n      sandbox.shadowRoot.host.appendChild(fontStyleSheetElement);\n    }\n    stylesheetElement._patcher = undefined;\n  };\n  if (stylesheetElement._patcher) {\n    clearTimeout(stylesheetElement._patcher);\n  }\n  stylesheetElement._patcher = setTimeout(patcher, 50);\n}\n\n/**\n * 劫持处理样式元素的属性\n */\nfunction patchStylesheetElement(\n  stylesheetElement: HTMLStyleElement & { _hasPatchStyle?: boolean },\n  cssLoader: (code: string, url: string, base: string) => string,\n  sandbox: Wujie,\n  curUrl: string\n) {\n  if (stylesheetElement._hasPatchStyle) return;\n  const innerHTMLDesc = Object.getOwnPropertyDescriptor(Element.prototype, \"innerHTML\");\n  const innerTextDesc = Object.getOwnPropertyDescriptor(HTMLElement.prototype, \"innerText\");\n  const textContentDesc = Object.getOwnPropertyDescriptor(Node.prototype, \"textContent\");\n  const RawInsertRule = stylesheetElement.sheet?.insertRule;\n  // 这个地方将cssRule加到innerHTML中去，防止子应用切换之后丢失\n  function patchSheetInsertRule() {\n    if (!RawInsertRule) return;\n    stylesheetElement.sheet.insertRule = (rule: string, index?: number): number => {\n      innerHTMLDesc ? (stylesheetElement.innerHTML += rule) : (stylesheetElement.innerText += rule);\n      return RawInsertRule.call(stylesheetElement.sheet, rule, index);\n    };\n  }\n  patchSheetInsertRule();\n\n  if (innerHTMLDesc) {\n    Object.defineProperties(stylesheetElement, {\n      innerHTML: {\n        get: function () {\n          return innerHTMLDesc.get.call(stylesheetElement);\n        },\n        set: function (code: string) {\n          innerHTMLDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n          nextTick(() => handleStylesheetElementPatch(this, sandbox));\n        },\n      },\n    });\n  }\n\n  Object.defineProperties(stylesheetElement, {\n    innerText: {\n      get: function () {\n        return innerTextDesc.get.call(stylesheetElement);\n      },\n      set: function (code: string) {\n        innerTextDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n      },\n    },\n    textContent: {\n      get: function () {\n        return textContentDesc.get.call(stylesheetElement);\n      },\n      set: function (code: string) {\n        textContentDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n      },\n    },\n    appendChild: {\n      value: function (node: Node): Node {\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n        if (node.nodeType === Node.TEXT_NODE) {\n          const res = rawAppendChild.call(\n            stylesheetElement,\n            stylesheetElement.ownerDocument.createTextNode(cssLoader(node.textContent, \"\", curUrl))\n          );\n          // 当appendChild之后，样式元素的sheet对象发生改变，要重新patch\n          patchSheetInsertRule();\n          return res;\n        } else return rawAppendChild(node);\n      },\n    },\n    _hasPatchStyle: { get: () => true },\n  });\n}\n\nlet dynamicScriptExecStack = Promise.resolve();\nfunction rewriteAppendOrInsertChild(opts: {\n  rawDOMAppendOrInsertBefore: <T extends Node>(newChild: T, refChild?: Node | null) => T;\n  wujieId: string;\n}) {\n  return function appendChildOrInsertBefore<T extends Node>(\n    this: HTMLHeadElement | HTMLBodyElement,\n    newChild: T,\n    refChild?: Node | null\n  ) {\n    let element = newChild as any;\n    const { rawDOMAppendOrInsertBefore, wujieId } = opts;\n    const sandbox = getWujieById(wujieId);\n\n    const { styleSheetElements, replace, fetch, plugins, iframe, lifecycles, proxyLocation, fiber } = sandbox;\n\n    if (!isHijackingTag(element.tagName) || !wujieId) {\n      const res = rawDOMAppendOrInsertBefore.call(this, element, refChild) as T;\n      patchElementEffect(element, iframe.contentWindow);\n      execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n      return res;\n    }\n\n    const iframeDocument = iframe.contentDocument;\n    const curUrl = getCurUrl(proxyLocation);\n\n    // TODO 过滤可以开放\n    if (element.tagName) {\n      switch (element.tagName?.toUpperCase()) {\n        case \"LINK\": {\n          const { href, rel, type } = element as HTMLLinkElement;\n          const styleFlag = rel === \"stylesheet\" || type === \"text/css\" || href.endsWith(\".css\");\n          // 非 stylesheet 不做处理\n          if (!styleFlag) {\n            const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n            return res;\n          }\n          // 排除css\n          if (href && !isMatchUrl(href, getEffectLoaders(\"cssExcludes\", plugins))) {\n            getExternalStyleSheets(\n              [{ src: href, ignore: isMatchUrl(href, getEffectLoaders(\"cssIgnores\", plugins)) }],\n              fetch,\n              lifecycles.loadError\n            ).forEach(({ src, ignore, contentPromise }) =>\n              contentPromise.then(\n                (content) => {\n                  // 处理 ignore 样式\n                  const rawAttrs = parseTagAttributes(element.outerHTML);\n                  if (ignore && src) {\n                    const stylesheetElement = iframeDocument.createElement(\"link\");\n                    const attrs = {\n                      ...rawAttrs,\n                      type: \"text/css\",\n                      rel: \"stylesheet\",\n                      href: src,\n                    };\n                    setAttrsToElement(stylesheetElement, attrs);\n                    rawDOMAppendOrInsertBefore.call(this, stylesheetElement, refChild);\n                    manualInvokeElementEvent(element, \"load\");\n                  } else {\n                    // 记录js插入样式，子应用重新激活时恢复\n                    const stylesheetElement = iframeDocument.createElement(\"style\");\n                    // 处理css-loader插件\n                    const cssLoader = getCssLoader({ plugins, replace });\n                    stylesheetElement.innerHTML = cssLoader(content, src, curUrl);\n                    styleSheetElements.push(stylesheetElement);\n                    setAttrsToElement(stylesheetElement, rawAttrs);\n                    rawDOMAppendOrInsertBefore.call(this, stylesheetElement, refChild);\n                    // 处理样式补丁\n                    handleStylesheetElementPatch(stylesheetElement, sandbox);\n                    manualInvokeElementEvent(element, \"load\");\n                  }\n                  element = null;\n                },\n                () => {\n                  manualInvokeElementEvent(element, \"error\");\n                  element = null;\n                }\n              )\n            );\n          }\n\n          const comment = iframeDocument.createComment(`dynamic link ${href} replaced by wujie`);\n          return rawDOMAppendOrInsertBefore.call(this, comment, refChild);\n        }\n        case \"STYLE\": {\n          const stylesheetElement: HTMLStyleElement = newChild as any;\n          styleSheetElements.push(stylesheetElement);\n          const content = stylesheetElement.innerHTML;\n          const cssLoader = getCssLoader({ plugins, replace });\n          content && (stylesheetElement.innerHTML = cssLoader(content, \"\", curUrl));\n          const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n          // 处理样式补丁\n          patchStylesheetElement(stylesheetElement, cssLoader, sandbox, curUrl);\n          handleStylesheetElementPatch(stylesheetElement, sandbox);\n          execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n          return res;\n        }\n        case \"SCRIPT\": {\n          setTagToScript(element);\n          const { src, text, type, crossOrigin } = element as HTMLScriptElement;\n          // 排除js\n          if (src && !isMatchUrl(src, getEffectLoaders(\"jsExcludes\", plugins))) {\n            const execScript = (scriptResult: ScriptObject) => {\n              // 假如子应用被连续渲染两次，两次渲染会导致处理流程的交叉污染\n              if (sandbox.iframe === null) return warn(WUJIE_TIPS_REPEAT_RENDER);\n              const onload = () => {\n                manualInvokeElementEvent(element, \"load\");\n                element = null;\n              };\n              insertScriptToIframe({ ...scriptResult, onload }, sandbox.iframe.contentWindow, element);\n            };\n            const scriptOptions = {\n              src,\n              module: type === \"module\",\n              crossorigin: crossOrigin !== null,\n              crossoriginType: crossOrigin || \"\",\n              ignore: isMatchUrl(src, getEffectLoaders(\"jsIgnores\", plugins)),\n              attrs: parseTagAttributes(element.outerHTML),\n            } as ScriptObject;\n            getExternalScripts([scriptOptions], fetch, lifecycles.loadError, fiber).forEach((scriptResult) => {\n              dynamicScriptExecStack = dynamicScriptExecStack.then(() =>\n                scriptResult.contentPromise.then(\n                  (content) => {\n                    if (sandbox.execQueue === null) return warn(WUJIE_TIPS_REPEAT_RENDER);\n                    const execQueueLength = sandbox.execQueue?.length;\n                    sandbox.execQueue.push(() =>\n                      fiber\n                        ? requestIdleCallback(() => {\n                            execScript({ ...scriptResult, content });\n                          })\n                        : execScript({ ...scriptResult, content })\n                    );\n                    // 同步脚本如果都执行完了，需要手动触发执行\n                    if (!execQueueLength) sandbox.execQueue.shift()();\n                  },\n                  () => {\n                    manualInvokeElementEvent(element, \"error\");\n                    element = null;\n                  }\n                )\n              );\n            });\n          } else {\n            const execQueueLength = sandbox.execQueue?.length;\n            sandbox.execQueue.push(() =>\n              fiber\n                ? requestIdleCallback(() => {\n                    insertScriptToIframe(\n                      { src: null, content: text, attrs: parseTagAttributes(element.outerHTML) },\n                      sandbox.iframe.contentWindow,\n                      element\n                    );\n                  })\n                : insertScriptToIframe(\n                    { src: null, content: text, attrs: parseTagAttributes(element.outerHTML) },\n                    sandbox.iframe.contentWindow,\n                    element\n                  )\n            );\n            if (!execQueueLength) sandbox.execQueue.shift()();\n          }\n          // inline script never trigger the onload and onerror event\n          const comment = iframeDocument.createComment(`dynamic script ${src} replaced by wujie`);\n          return rawDOMAppendOrInsertBefore.call(this, comment, refChild);\n        }\n        // 修正子应用内部iframe的window.parent指向\n        case \"IFRAME\": {\n          // 嵌套的子应用的js-iframe需要插入子应用的js-iframe内部\n          if (element.getAttribute(WUJIE_DATA_FLAG) === \"\") {\n            return rawAppendChild.call(rawDocumentQuerySelector.call(this.ownerDocument, \"html\"), element);\n          }\n          const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n          execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n          return res;\n        }\n        default:\n      }\n    }\n  };\n}\n\nfunction findScriptElementFromIframe(rawElement: HTMLScriptElement, wujieId: string) {\n  const wujieTag = getTagFromScript(rawElement);\n  const sandbox = getWujieById(wujieId);\n  const { iframe } = sandbox;\n  const targetScript = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_HEAD__.querySelector(\n    `script[${WUJIE_SCRIPT_ID}='${wujieTag}']`\n  );\n  if (targetScript === null) {\n    warn(WUJIE_TIPS_NO_SCRIPT, `<script ${WUJIE_SCRIPT_ID}='${wujieTag}'/>`);\n  }\n  return { targetScript, iframe };\n}\n\nfunction rewriteContains(opts: { rawElementContains: (other: Node | null) => boolean; wujieId: string }) {\n  return function contains(other: Node | null) {\n    const element = other as HTMLElement;\n    const { rawElementContains, wujieId } = opts;\n    if (element && isScriptElement(element)) {\n      const { targetScript } = findScriptElementFromIframe(element as HTMLScriptElement, wujieId);\n      return targetScript !== null;\n    }\n    return rawElementContains(element);\n  };\n}\n\nfunction rewriteRemoveChild(opts: { rawElementRemoveChild: <T extends Node>(child: T) => T; wujieId: string }) {\n  return function removeChild(child: Node) {\n    const element = child as HTMLElement;\n    const { rawElementRemoveChild, wujieId } = opts;\n    if (element && isScriptElement(element)) {\n      const { targetScript, iframe } = findScriptElementFromIframe(element as HTMLScriptElement, wujieId);\n      if (targetScript !== null) {\n        return iframe.contentWindow.__WUJIE_RAW_DOCUMENT_HEAD__.removeChild(targetScript);\n      }\n      return null;\n    }\n    return rawElementRemoveChild(element);\n  };\n}\n\n/**\n * 记录head和body的事件，等重新渲染复用head和body时需要清空事件\n */\nfunction patchEventListener(element: HTMLHeadElement | HTMLBodyElement) {\n  const listenerMap = new Map<string, EventListenerOrEventListenerObject[]>();\n  element._cacheListeners = listenerMap;\n\n  element.addEventListener = (\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ) => {\n    const listeners = listenerMap.get(type) || [];\n    listenerMap.set(type, [...listeners, listener]);\n    return rawAddEventListener.call(element, type, listener, options);\n  };\n\n  element.removeEventListener = (\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ) => {\n    const typeListeners = listenerMap.get(type);\n    const index = typeListeners?.indexOf(listener);\n    if (typeListeners?.length && index !== -1) {\n      typeListeners.splice(index, 1);\n    }\n    return rawRemoveEventListener.call(element, type, listener, options);\n  };\n}\n\n/**\n * 清空head和body的绑定的事件\n */\nexport function removeEventListener(element: HTMLHeadElement | HTMLBodyElement) {\n  const listenerMap = element._cacheListeners;\n  [...listenerMap.entries()].forEach(([type, listeners]) => {\n    listeners.forEach((listener) => rawRemoveEventListener.call(element, type, listener));\n  });\n}\n\n/**\n * patch head and body in render\n * intercept appendChild and insertBefore\n */\nexport function patchRenderEffect(render: ShadowRoot | Document, id: string, degrade: boolean): void {\n  // 降级场景dom渲染在iframe中，iframe移动后事件自动销毁，不需要记录\n  if (!degrade) {\n    patchEventListener(render.head);\n    patchEventListener(render.body as HTMLBodyElement);\n  }\n\n  render.head.appendChild = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawAppendChild,\n    wujieId: id,\n  }) as typeof rawAppendChild;\n  render.head.insertBefore = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawHeadInsertBefore as any,\n    wujieId: id,\n  }) as typeof rawHeadInsertBefore;\n  render.head.removeChild = rewriteRemoveChild({\n    rawElementRemoveChild: rawElementRemoveChild.bind(render.head),\n    wujieId: id,\n  }) as typeof rawElementRemoveChild;\n  render.head.contains = rewriteContains({\n    rawElementContains: rawElementContains.bind(render.head),\n    wujieId: id,\n  }) as typeof rawElementContains;\n  render.contains = rewriteContains({\n    rawElementContains: rawElementContains.bind(render),\n    wujieId: id,\n  }) as typeof rawElementContains;\n  render.body.appendChild = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawAppendChild,\n    wujieId: id,\n  }) as typeof rawAppendChild;\n  render.body.insertBefore = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawBodyInsertBefore as any,\n    wujieId: id,\n  }) as typeof rawBodyInsertBefore;\n}\n"],"mappings":"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"}