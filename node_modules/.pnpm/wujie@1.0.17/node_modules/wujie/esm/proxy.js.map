{"version":3,"file":"proxy.js","names":["patchElementEffect","renderIframeReplaceApp","renderElementToContainer","pushUrlToWindow","documentProxyProperties","rawDocumentQuerySelector","WUJIE_TIPS_RELOAD_DISABLED","getTargetValue","anchorElementGenerator","getDegradeIframe","isCallable","checkProxyFunction","warn","stopMainAppRun","locationHrefSet","iframe","value","appHostPath","contentWindow","__WUJIE","shadowRoot","id","degrade","document","degradeAttrs","url","test","hrefElement","pathname","search","hash","hrefFlag","iframeBody","call","contentDocument","documentElement","window","decodeURIComponent","parentElement","host","proxyGenerator","urlElement","mainHostPath","proxyWindow","Proxy","get","target","p","proxyLocation","Object","getOwnPropertyDescriptor","proxy","set","has","proxyDocument","_fakeDocument","propKey","rawCreateElement","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","rawCreateTextNode","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","apply","_createElement","_ctx","args","rawCreateMethod","element","href","querySelectorAll","arg","scripts","res","error","querySelector","ctx","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","rawPropMap","firstElementChild","ownerProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","concat","includes","toString","activeElement","body","_fakeLocation","location","replace","ownKeys","keys","filter","key","_target","enumerable","configurable","localGenerator","sandbox","defineProperties","createElement","createTextNode","documentURI","URL","getElementsByTagName","tagName","modifyLocalProperties","modifyProperties","forEach","defineProperty","bind","locationKeys","constantKey","reload"],"sources":["../src/proxy.ts"],"sourcesContent":["import { patchElementEffect, renderIframeReplaceApp } from \"./iframe\";\nimport { renderElementToContainer } from \"./shadow\";\nimport { pushUrlToWindow } from \"./sync\";\nimport { documentProxyProperties, rawDocumentQuerySelector } from \"./common\";\nimport { WUJIE_TIPS_RELOAD_DISABLED } from \"./constant\";\nimport {\n  getTargetValue,\n  anchorElementGenerator,\n  getDegradeIframe,\n  isCallable,\n  checkProxyFunction,\n  warn,\n  stopMainAppRun,\n} from \"./utils\";\n\n/**\n * location href 的set劫持操作\n */\nfunction locationHrefSet(iframe: HTMLIFrameElement, value: string, appHostPath: string): boolean {\n  const { shadowRoot, id, degrade, document, degradeAttrs } = iframe.contentWindow.__WUJIE;\n  let url = value;\n  if (!/^http/.test(url)) {\n    let hrefElement = anchorElementGenerator(url);\n    url = appHostPath + hrefElement.pathname + hrefElement.search + hrefElement.hash;\n    hrefElement = null;\n  }\n  iframe.contentWindow.__WUJIE.hrefFlag = true;\n  if (degrade) {\n    const iframeBody = rawDocumentQuerySelector.call(iframe.contentDocument, \"body\");\n    renderElementToContainer(document.documentElement, iframeBody);\n    renderIframeReplaceApp(window.decodeURIComponent(url), getDegradeIframe(id).parentElement, degradeAttrs);\n  } else renderIframeReplaceApp(url, shadowRoot.host.parentElement, degradeAttrs);\n  pushUrlToWindow(id, url);\n  return true;\n}\n\n/**\n * 非降级情况下window、document、location代理\n */\nexport function proxyGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyWindow: Window;\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  const proxyWindow = new Proxy(iframe.contentWindow, {\n    get: (target: Window, p: PropertyKey): any => {\n      // location进行劫持\n      if (p === \"location\") {\n        return target.__WUJIE.proxyLocation;\n      }\n      // 判断自身\n      if (p === \"self\" || (p === \"window\" && Object.getOwnPropertyDescriptor(window, \"window\").get)) {\n        return target.__WUJIE.proxy;\n      }\n      // 不要绑定this\n      if (p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\" || p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\") {\n        return target[p];\n      }\n      // 修正this指针指向\n      return getTargetValue(target, p);\n    },\n\n    set: (target: Window, p: PropertyKey, value: any) => {\n      checkProxyFunction(value);\n      target[p] = value;\n      return true;\n    },\n\n    has: (target: Window, p: PropertyKey) => p in target,\n  });\n\n  // proxy document\n  const proxyDocument = new Proxy(\n    {},\n    {\n      get: function (_fakeDocument, propKey) {\n        const document = window.document;\n        const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;\n        // iframe初始化完成后，webcomponent还未挂在上去，此时运行了主应用代码，必须中止\n        if (!shadowRoot) stopMainAppRun();\n        const rawCreateElement = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__;\n        const rawCreateTextNode = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__;\n        // need fix\n        if (propKey === \"createElement\" || propKey === \"createTextNode\") {\n          return new Proxy(document[propKey], {\n            apply(_createElement, _ctx, args) {\n              const rawCreateMethod = propKey === \"createElement\" ? rawCreateElement : rawCreateTextNode;\n              const element = rawCreateMethod.apply(iframe.contentDocument, args);\n              patchElementEffect(element, iframe.contentWindow);\n              return element;\n            },\n          });\n        }\n        if (propKey === \"documentURI\" || propKey === \"URL\") {\n          return (proxyLocation as Location).href;\n        }\n\n        // from shadowRoot\n        if (\n          propKey === \"getElementsByTagName\" ||\n          propKey === \"getElementsByClassName\" ||\n          propKey === \"getElementsByName\"\n        ) {\n          return new Proxy(shadowRoot.querySelectorAll, {\n            apply(querySelectorAll, _ctx, args) {\n              let arg = args[0];\n              if (_ctx !== iframe.contentDocument) {\n                return _ctx[propKey].apply(_ctx, args);\n              }\n\n              if (propKey === \"getElementsByTagName\" && arg === \"script\") {\n                return iframe.contentDocument.scripts;\n              }\n              if (propKey === \"getElementsByClassName\") arg = \".\" + arg;\n              if (propKey === \"getElementsByName\") arg = `[name=\"${arg}\"]`;\n\n              // FIXME: This string must be a valid CSS selector string; if it's not, a SyntaxError exception is thrown;\n              // so we should ensure that the program can execute normally in case of exceptions.\n              // reference: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll\n\n              let res: NodeList[] | [];\n              try {\n                res = querySelectorAll.call(shadowRoot, arg);\n              } catch (error) {\n                res = [];\n              }\n\n              return res;\n            },\n          });\n        }\n        if (propKey === \"getElementById\") {\n          return new Proxy(shadowRoot.querySelector, {\n            // case document.querySelector.call\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              return (\n                target.call(shadowRoot, `[id=\"${args[0]}\"]`) ||\n                iframe.contentWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__.call(\n                  iframe.contentWindow.document,\n                  `#${args[0]}`\n                )\n              );\n            },\n          });\n        }\n        if (propKey === \"querySelector\" || propKey === \"querySelectorAll\") {\n          const rawPropMap = {\n            querySelector: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\",\n            querySelectorAll: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\",\n          };\n          return new Proxy(shadowRoot[propKey], {\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              // 二选一，优先shadowDom，除非采用array合并，排除base，防止对router造成影响\n              return (\n                target.apply(shadowRoot, args) ||\n                (args[0] === \"base\"\n                  ? null\n                  : iframe.contentWindow[rawPropMap[propKey]].call(iframe.contentWindow.document, args[0]))\n              );\n            },\n          });\n        }\n        if (propKey === \"documentElement\" || propKey === \"scrollingElement\") return shadowRoot.firstElementChild;\n        if (propKey === \"forms\") return shadowRoot.querySelectorAll(\"form\");\n        if (propKey === \"images\") return shadowRoot.querySelectorAll(\"img\");\n        if (propKey === \"links\") return shadowRoot.querySelectorAll(\"a\");\n        const { ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods } =\n          documentProxyProperties;\n        if (ownerProperties.concat(shadowProperties).includes(propKey.toString())) {\n          if (propKey === \"activeElement\" && shadowRoot.activeElement === null) return shadowRoot.body;\n          return shadowRoot[propKey];\n        }\n        if (shadowMethods.includes(propKey.toString())) {\n          return getTargetValue(shadowRoot, propKey) ?? getTargetValue(document, propKey);\n        }\n        // from window.document\n        if (documentProperties.includes(propKey.toString())) {\n          return document[propKey];\n        }\n        if (documentMethods.includes(propKey.toString())) {\n          return getTargetValue(document, propKey);\n        }\n      },\n    }\n  );\n\n  // proxy location\n  const proxyLocation = new Proxy(\n    {},\n    {\n      get: function (_fakeLocation, propKey) {\n        const location = iframe.contentWindow.location;\n        if (\n          propKey === \"host\" ||\n          propKey === \"hostname\" ||\n          propKey === \"protocol\" ||\n          propKey === \"port\" ||\n          propKey === \"origin\"\n        ) {\n          return urlElement[propKey];\n        }\n        if (propKey === \"href\") {\n          return location[propKey].replace(mainHostPath, appHostPath);\n        }\n        if (propKey === \"reload\") {\n          warn(WUJIE_TIPS_RELOAD_DISABLED);\n          return () => null;\n        }\n        if (propKey === \"replace\") {\n          return new Proxy(location[propKey], {\n            apply(replace, _ctx, args) {\n              return replace.call(location, args[0]?.replace(appHostPath, mainHostPath));\n            },\n          });\n        }\n        return getTargetValue(location, propKey);\n      },\n      set: function (_fakeLocation, propKey, value) {\n        // 如果是跳转链接的话重开一个iframe\n        if (propKey === \"href\") {\n          return locationHrefSet(iframe, value, appHostPath);\n        }\n        iframe.contentWindow.location[propKey] = value;\n        return true;\n      },\n      ownKeys: function () {\n        return Object.keys(iframe.contentWindow.location).filter((key) => key !== \"reload\");\n      },\n      getOwnPropertyDescriptor: function (_target, key) {\n        return { enumerable: true, configurable: true, value: this[key] };\n      },\n    }\n  );\n  return { proxyWindow, proxyDocument, proxyLocation };\n}\n\n/**\n * 降级情况下document、location代理处理\n */\nexport function localGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  // 代理 document\n  const proxyDocument = {};\n  const sandbox = iframe.contentWindow.__WUJIE;\n  // 特殊处理\n  Object.defineProperties(proxyDocument, {\n    createElement: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    createTextNode: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    documentURI: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    URL: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    getElementsByTagName: {\n      get() {\n        return function (...args) {\n          const tagName = args[0];\n          if (tagName === \"script\") {\n            return iframe.contentDocument.scripts as any;\n          }\n          return sandbox.document.getElementsByTagName(tagName) as any;\n        };\n      },\n    },\n  });\n  // 普通处理\n  const {\n    modifyLocalProperties,\n    modifyProperties,\n    ownerProperties,\n    shadowProperties,\n    shadowMethods,\n    documentProperties,\n    documentMethods,\n  } = documentProxyProperties;\n  modifyProperties\n    .filter((key) => !modifyLocalProperties.includes(key))\n    .concat(ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods)\n    .forEach((key) => {\n      Object.defineProperty(proxyDocument, key, {\n        get: () => {\n          const value = sandbox.document?.[key];\n          return isCallable(value) ? value.bind(sandbox.document) : value;\n        },\n      });\n    });\n\n  // 代理 location\n  const proxyLocation = {};\n  const location = iframe.contentWindow.location;\n  const locationKeys = Object.keys(location);\n  const constantKey = [\"host\", \"hostname\", \"port\", \"protocol\", \"port\"];\n  constantKey.forEach((key) => {\n    proxyLocation[key] = urlElement[key];\n  });\n  Object.defineProperties(proxyLocation, {\n    href: {\n      get: () => location.href.replace(mainHostPath, appHostPath),\n      set: (value) => {\n        locationHrefSet(iframe, value, appHostPath);\n      },\n    },\n    reload: {\n      get() {\n        warn(WUJIE_TIPS_RELOAD_DISABLED);\n        return () => null;\n      },\n    },\n  });\n  locationKeys\n    .filter((key) => !constantKey.concat([\"href\", \"reload\"]).includes(key))\n    .forEach((key) => {\n      Object.defineProperty(proxyLocation, key, {\n        get: () => (isCallable(location[key]) ? location[key].bind(location) : location[key]),\n      });\n    });\n  return { proxyDocument, proxyLocation };\n}\n"],"mappings":"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"}