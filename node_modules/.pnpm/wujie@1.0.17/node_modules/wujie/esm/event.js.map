{"version":3,"file":"event.js","names":["warn","error","WUJIE_ALL_EVENT","WUJIE_TIPS_NO_SUBJECT","appEventObjMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","Map","EventBus","id","$clear","get","set","eventObj","event","fn","cbs","includes","push","$on","on","$off","bind","length","cb","i","splice","allCbs","forEach","concat","args","l","e","events","Object","keys"],"sources":["../src/event.ts"],"sourcesContent":["import { warn, error } from \"./utils\";\nimport { WUJIE_ALL_EVENT, WUJIE_TIPS_NO_SUBJECT } from \"./constant\";\n\nexport type EventObj = { [event: string]: Array<Function> };\n\n// 全部事件存储map\nexport const appEventObjMap = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE.inject.appEventObjMap\n  : new Map<String, EventObj>();\n\n// eventBus 事件中心\nexport class EventBus {\n  private id: string;\n  private eventObj: EventObj;\n\n  constructor(id: string) {\n    this.id = id;\n    this.$clear();\n    if (!appEventObjMap.get(this.id)) {\n      appEventObjMap.set(this.id, {});\n    }\n    this.eventObj = appEventObjMap.get(this.id);\n  }\n\n  // 监听事件\n  public $on(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!cbs) {\n      this.eventObj[event] = [fn];\n      return this;\n    }\n    if (!cbs.includes(fn)) cbs.push(fn);\n    return this;\n  }\n\n  /** 任何$emit都会导致监听函数触发，第一个参数为事件名，后续的参数为$emit的参数 */\n  public $onAll(fn: (event: string, ...args: Array<any>) => any): EventBus {\n    return this.$on(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 一次性监听事件\n  public $once(event: string, fn: Function): void {\n    const on = function (...args: Array<any>) {\n      this.$off(event, on);\n      fn(...args);\n    }.bind(this);\n    this.$on(event, on);\n  }\n\n  // 取消监听\n  public $off(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!event || !cbs || !cbs.length) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n      return this;\n    }\n\n    let cb;\n    let i = cbs.length;\n    while (i--) {\n      cb = cbs[i];\n      if (cb === fn) {\n        cbs.splice(i, 1);\n        break;\n      }\n    }\n    return this;\n  }\n\n  // 取消监听$onAll\n  public $offAll(fn: Function): EventBus {\n    return this.$off(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 发送事件\n  public $emit(event: string, ...args: Array<any>): EventBus {\n    let cbs = [];\n    let allCbs = [];\n\n    appEventObjMap.forEach((eventObj) => {\n      if (eventObj[event]) cbs = cbs.concat(eventObj[event]);\n      if (eventObj[WUJIE_ALL_EVENT]) allCbs = allCbs.concat(eventObj[WUJIE_ALL_EVENT]);\n    });\n\n    if (!event || (cbs.length === 0 && allCbs.length === 0)) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n    } else {\n      try {\n        for (let i = 0, l = cbs.length; i < l; i++) cbs[i](...args);\n        for (let i = 0, l = allCbs.length; i < l; i++) allCbs[i](event, ...args);\n      } catch (e) {\n        error(e);\n      }\n    }\n    return this;\n  }\n\n  // 清空当前所有的监听事件\n  public $clear(): EventBus {\n    const eventObj = appEventObjMap.get(this.id) ?? {};\n    const events = Object.keys(eventObj);\n    events.forEach((event) => delete eventObj[event]);\n    return this;\n  }\n}\n"],"mappings":"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"}